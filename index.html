<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LensLink - Online Photography Booking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script type="text/javascript">
        (function() {
            emailjs.init('CwsYX5H2E_UgSznPF');
        })();
    </script>
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #f8fafc; /* slate-50 */
            letter-spacing: -0.01em;
        }
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-weight: 700;
            letter-spacing: -0.02em;
        }
        input, textarea, select, button {
            font-family: 'Plus Jakarta Sans', sans-serif;
        }
        .font-serif-display {
            font-family: 'Playfair Display', serif;
        }
        .nav-link {
            transition: color 0.3s;
        }
        .nav-link:hover {
            color: #fb923c; /* orange-400 */
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .hero-bg {
            background-image: url('https://images.unsplash.com/photo-1516035069371-29a1b244cc32?q=80&w=2864&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
        }
        .flatpickr-day.selected {
            background: #fb923c;
            border-color: #fb923c;
        }
        .flatpickr-day.today {
            border-color: #fb923c;
        }
        .flatpickr-day.disabled {
            color: #94a3b8; /* slate-400 */
        }
        .booking-step {
            display: none;
        }
        .booking-step.active {
            display: block;
        }
        
        /* Mobile optimizations */
        @media (max-width: 640px) {
            .booking-step h3 {
                font-size: 1.25rem;
            }
            
            .time-slot-btn {
                padding: 0.5rem;
                font-size: 0.875rem;
            }
            
            #booking-calendar {
                font-size: 0.875rem;
            }
            
            #booking-modal .p-6 {
                padding: 1rem;
            }
        }
    </style>
</head>
<body class="text-slate-800">

    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-lg sticky top-0 z-50 shadow-sm">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="#" class="text-2xl font-bold text-slate-900 font-serif-display" data-page="home">LensLink</a>
            <div class="hidden md:flex items-center space-x-8">
                <a href="#" class="nav-link" data-page="home">Home</a>
                <a href="#" class="nav-link" data-page="about">About</a>
                <a href="#" class="nav-link" data-page="contact">Contact</a>
            </div>
            <div class="hidden md:flex items-center space-x-4">
                <div id="auth-buttons" class="flex items-center space-x-4">
                    <a href="#" class="px-4 py-2 text-sm font-medium rounded-md hover:bg-slate-100" data-page="login">Log In</a>
                    <a href="#" class="px-4 py-2 text-sm font-medium text-white bg-slate-800 rounded-md hover:bg-slate-700" data-page="login">Register</a>
                </div>
                <div id="user-menu" class="hidden flex items-center space-x-4">
                    <span id="user-welcome" class="text-sm text-slate-600"></span>
                    <div class="relative">
                        <button id="user-menu-button" class="flex items-center space-x-2 px-4 py-2 text-sm font-medium rounded-md hover:bg-slate-100">
                            <img id="user-avatar" src="" alt="User Avatar" class="w-8 h-8 rounded-full">
                            <span id="user-name"></span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div id="user-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50">
                            <a href="#" id="find-photographers-link" class="hidden block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100">Find Photographers</a>
                            <a href="#" id="my-bookings" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100">My Bookings</a>
                            <a href="#" id="my-profile" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100">Profile</a>
                            <div id="photographer-menu" class="hidden">
                                <a href="#" id="my-recent-bookings" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100">My Recent Bookings</a>
                            </div>
                            <hr class="my-1">
                            <a href="#" id="logout-btn" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100">Logout</a>
                        </div>
                    </div>
                </div>
            </div>
            <button id="mobile-menu-button" class="md:hidden">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>
        </nav>
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden px-6 pb-4 space-y-2">
            <a href="#" class="block nav-link" data-page="home">Home</a>
            <a href="#" class="block nav-link" data-page="about">About</a>
            <a href="#" class="block nav-link" data-page="contact">Contact</a>
            <div class="border-t border-slate-200 pt-4 space-y-2">
                 <a href="#" class="block text-center px-4 py-2 text-sm font-medium rounded-md hover:bg-slate-100" data-page="login">Log In</a>
                <a href="#" class="block text-center px-4 py-2 text-sm font-medium text-white bg-slate-800 rounded-md hover:bg-slate-700" data-page="login">Register</a>
            </div>
        </div>
    </header>

    <main>
        <!-- Home Page -->
        <div id="home" class="page active">
            <!-- Hero Section -->
            <section class="hero-bg text-white min-h-[60vh] flex items-center">
                <div class="container mx-auto px-6 text-center bg-black/50 py-20 rounded-lg">
                    <h1 class="text-4xl md:text-6xl font-bold font-serif-display mb-4">Capture Your Moments, Effortlessly</h1>
                    <p class="text-lg md:text-xl mb-8 max-w-3xl mx-auto">Connect with professional photographers and showcase your photography skills. Join our community of talented artists.</p>
                    <a href="#" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-8 rounded-full text-lg transition duration-300" data-page="login">Join LensLink Community</a>
                </div>
            </section>

            <!-- Features Section -->
            <section class="py-16 bg-white">
                <div class="container mx-auto px-6">
                    <div class="text-center mb-12">
                        <h2 class="text-3xl font-bold font-serif-display">Why Choose LensLink?</h2>
                        <p class="text-slate-600 mt-2">A seamless experience for clients and photographers alike.</p>
                    </div>
                    <div class="grid md:grid-cols-3 gap-8 text-center">
                        <div class="p-6">
                            <div class="flex items-center justify-center h-16 w-16 rounded-full bg-orange-100 text-orange-500 mx-auto mb-4">
                                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            </div>
                            <h3 class="text-xl font-semibold mb-2">Instant Booking</h3>
                            <p class="text-slate-600">Book your preferred photographer anytime, anywhere. Check real-time availability and get instant confirmation.</p>
                        </div>
                        <div class="p-6">
                            <div class="flex items-center justify-center h-16 w-16 rounded-full bg-orange-100 text-orange-500 mx-auto mb-4">
                                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                            </div>
                            <h3 class="text-xl font-semibold mb-2">Discover Talent</h3>
                            <p class="text-slate-600">Explore portfolios of talented photographers. Search by specialty, location, or name to find the perfect match for your needs.</p>
                        </div>
                        <div class="p-6">
                            <div class="flex items-center justify-center h-16 w-16 rounded-full bg-orange-100 text-orange-500 mx-auto mb-4">
                                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </div>
                            <h3 class="text-xl font-semibold mb-2">Secure & Simple</h3>
                            <p class="text-slate-600">All your booking details are managed in one place. Secure payments and clear communication from start to finish.</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- About Page -->
        <div id="about" class="page container mx-auto px-6 py-16">
            <div class="text-center mb-12">
                <h1 class="text-4xl font-bold font-serif-display">Modernizing Photography Bookings</h1>
                <p class="text-lg text-slate-600 mt-2">Replacing inefficient manual methods with a streamlined online system.</p>
            </div>
            
            <div class="bg-white p-8 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold mb-4">Project Introduction</h2>
                <p class="text-slate-700 leading-relaxed">The "Online Photography Booking" project aims to modernize and improve the photography profession by creating a centralized digital platform. The primary goal is to simplify the entire procedure, making it significantly easier for clients to schedule a booking and for photographers to manage their work. This project will be useful and helpful by making professional photography services more accessible to everyone.</p>
            </div>

            <div class="grid md:grid-cols-2 gap-8 mt-12">
                <div class="bg-red-50 border border-red-200 p-8 rounded-lg">
                    <h3 class="text-2xl font-bold text-red-800 mb-4">The Existing System: Disadvantages</h3>
                    <ul class="space-y-3 text-red-700 list-disc list-inside">
                        <li>Difficult to track the real-time availability of photographers.</li>
                        <li>Managing bookings from multiple customers is inefficient and prone to error.</li>
                        <li>Process is inconvenient for clients, who cannot book outside of business hours.</li>
                        <li>Relies on phone calls and in-person visits, which is time-consuming.</li>
                    </ul>
                </div>
                <div class="bg-green-50 border border-green-200 p-8 rounded-lg">
                    <h3 class="text-2xl font-bold text-green-800 mb-4">The Proposed System: Advantages</h3>
                    <ul class="space-y-3 text-green-700 list-disc list-inside">
                        <li>Users can book a photographer anytime and from anywhere.</li>
                        <li>Instantly check the availability of photographers on a clear timetable.</li>
                        <li>All booking information is managed centrally and securely.</li>
                        <li>Safe, easy to retrieve data, and convenient for everyone involved.</li>
                    </ul>
                </div>
            </div>
            
            <div class="bg-white p-8 rounded-lg shadow-md mt-12">
                <h2 class="text-2xl font-bold mb-4">Technology Stack</h2>
                <p class="text-slate-700 mb-4">LensLink is built using a modern full-stack architecture: a Node.js/Express backend, MongoDB database, and Nodemailer email service, served alongside a responsive Tailwind CSS frontend.</p>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-semibold mb-3 text-orange-600">Frontend Technologies</h3>
                        <div class="flex flex-wrap gap-2">
                            <span class="bg-orange-100 text-orange-800 text-sm font-medium px-3 py-1 rounded-full">HTML5</span>
                            <span class="bg-blue-100 text-blue-800 text-sm font-medium px-3 py-1 rounded-full">CSS3</span>
                            <span class="bg-cyan-100 text-cyan-800 text-sm font-medium px-3 py-1 rounded-full">Tailwind CSS</span>
                            <span class="bg-yellow-100 text-yellow-800 text-sm font-medium px-3 py-1 rounded-full">JavaScript (ES6+)</span>
                            <span class="bg-purple-100 text-purple-800 text-sm font-medium px-3 py-1 rounded-full">Responsive Design</span>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-3 text-green-600">Backend & Database</h3>
                        <div class="flex flex-wrap gap-2">
                            <span class="bg-green-100 text-green-800 text-sm font-medium px-3 py-1 rounded-full">Node.js + Express</span>
                            <span class="bg-emerald-100 text-emerald-800 text-sm font-medium px-3 py-1 rounded-full">MongoDB + Mongoose</span>
                            <span class="bg-blue-100 text-blue-800 text-sm font-medium px-3 py-1 rounded-full">JWT Authentication</span>
                            <span class="bg-red-100 text-red-800 text-sm font-medium px-3 py-1 rounded-full">Nodemailer (Gmail)</span>
                            <span class="bg-slate-100 text-slate-800 text-sm font-medium px-3 py-1 rounded-full">REST API</span>
                        </div>
                    </div>
                </div>
                <div class="mt-6 grid md:grid-cols-3 gap-4">
                    <div class="bg-slate-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-slate-800 mb-2">🎨 UI Framework</h4>
                        <p class="text-sm text-slate-600">Tailwind CSS for modern, responsive styling with custom color schemes and animations</p>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-slate-800 mb-2"> Database</h4>
                        <p class="text-sm text-slate-600">MongoDB with Mongoose ODM â‚¬ persistent, cross-device storage for users, bookings, and photographer profiles</p>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-slate-800 mb-2">📧 Email Service</h4>
                        <p class="text-sm text-slate-600">Nodemailer with Gmail SMTP for registration verification, booking confirmations, and feedback notifications</p>
                    </div>
                </div>
                    <div class="mt-6 p-4 bg-orange-50 border border-orange-200 rounded-lg">
                    <h4 class="font-semibold text-orange-800 mb-2">★ Key Advantages</h4>
                    <ul class="text-sm text-orange-700 space-y-1">
                        <li><strong>Full-Stack:</strong> Node.js + Express REST API backend</li>
                        <li><strong>Persistent Storage:</strong> MongoDB â‚¬ data survives page reloads &amp; device switches</li>
                        <li><strong>Secure Passwords:</strong> bcrypt hashing â‚¬ never stored in plain text</li>
                        <li><strong>Email Verification:</strong> confirm your address before your account is fully active</li>
                        <li><strong>Mobile Responsive:</strong> Optimized for all device sizes</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Find Your Photographers Page (For logged-in clients) -->
        <div id="find-photographers" class="page container mx-auto px-6 py-16">
            <div class="text-center mb-12">
                <h1 class="text-4xl font-bold font-serif-display">Find Your Photographers</h1>
                <p class="text-lg text-slate-600 mt-2">Browse our talented photographers and book your perfect session.</p>
            </div>

            <!-- Search Bar -->
            <div class="mb-8 bg-white p-4 rounded-lg shadow-sm flex flex-col md:flex-row gap-4">
                <input type="text" id="photographer-search" placeholder="Search by name, e.g., 'Jane Doe'" class="flex-grow p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-orange-400 focus:border-transparent">
                <select id="specialty-filter" class="p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-orange-400 focus:border-transparent">
                    <option value="">All Specialties</option>
                    <option value="weddings">Weddings</option>
                    <option value="portraits">Portraits</option>
                    <option value="events">Events</option>
                    <option value="commercial">Commercial</option>
                    <option value="fashion">Fashion</option>
                    <option value="nature">Nature</option>
                    <option value="street">Street Photography</option>
                    <option value="sports">Sports</option>
                    <option value="other">Other</option>
                </select>
                <button onclick="searchRegisteredPhotographers()" class="bg-slate-800 text-white font-bold py-3 px-6 rounded-md hover:bg-slate-700">Search</button>
            </div>

            <!-- Photographer Grid -->
            <div id="registered-photographers-grid" class="grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                <!-- Dynamic photographer cards will be loaded here -->
                <div class="text-center py-8 col-span-full">
                    <p class="text-slate-500">Loading photographers...</p>
                </div>
            </div>
        </div>

        <!-- duplicate #photographers section removed â‚¬ use #find-photographers instead -->
        
        <!-- Photographer Profile Page -->
        <div id="profile" class="page container mx-auto px-6 py-16">
            <!-- Dynamic profile content will be loaded here by JavaScript -->
            <div class="text-center py-16">
                <p class="text-slate-500">Loading photographer profile...</p>
            </div>
        </div>

        <!-- User Profile Page -->
        <div id="user-profile" class="page container mx-auto px-6 py-16">
            <div class="max-w-4xl mx-auto">
                <div class="bg-white p-8 rounded-lg shadow-lg">
                    <div class="text-center mb-8">
                        <h1 class="text-3xl font-bold font-serif-display">My Profile</h1>
                        <p class="text-slate-600 mt-2">Manage your account information</p>
                    </div>
                    
                    <div id="user-profile-content" class="grid md:grid-cols-2 gap-8">
                        <!-- Profile content will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Contact / Feedback Page -->
        <div id="contact" class="page container mx-auto px-6 py-16">
            <div class="text-center mb-12">
                <h1 class="text-4xl font-bold font-serif-display">Get In Touch</h1>
                <p class="text-lg text-slate-600 mt-2">Have questions? We'd love to hear from you.</p>
            </div>
            <div class="max-w-2xl mx-auto bg-white p-8 rounded-lg shadow-md">
                <form id="contact-form" class="space-y-6">
                    <div>
                        <label for="contact-name" class="block text-sm font-medium text-slate-700">Full Name</label>
                        <input type="text" name="from_name" id="contact-name" required
                               class="mt-1 block w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-orange-400 focus:border-transparent">
                    </div>
                    <div>
                        <label for="contact-email" class="block text-sm font-medium text-slate-700">Email Address</label>
                        <input type="email" name="from_email" id="contact-email" required
                               class="mt-1 block w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-orange-400 focus:border-transparent">
                    </div>
                    <div>
                        <label for="contact-subject" class="block text-sm font-medium text-slate-700">Subject</label>
                        <input type="text" name="subject" id="contact-subject"
                               placeholder="General Enquiry"
                               class="mt-1 block w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-orange-400 focus:border-transparent">
                    </div>
                    <div>
                        <label for="contact-message" class="block text-sm font-medium text-slate-700">Message</label>
                        <textarea name="message" id="contact-message" rows="4" required
                                  class="mt-1 block w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-orange-400 focus:border-transparent"></textarea>
                    </div>
                    <div>
                        <button type="submit" id="contact-submit-btn"
                                class="w-full bg-slate-800 text-white font-bold py-3 px-6 rounded-md hover:bg-slate-700 transition-colors">
                            Send Message
                        </button>
                    </div>
                    <div id="contact-success" class="hidden p-4 bg-green-100 border border-green-400 text-green-700 rounded-md text-center"></div>
                    <div id="contact-error"   class="hidden p-4 bg-red-100   border border-red-400   text-red-700   rounded-md text-center"></div>
                </form>
            </div>
        </div>
        
        <!-- Login/Register Page -->
        <div id="login" class="page container mx-auto px-6 py-16">
            <div class="max-w-md mx-auto">
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <div class="flex justify-center mb-6">
                        <button id="login-tab" class="px-6 py-2 font-semibold text-lg border-b-2 border-orange-500 text-orange-500">Log In</button>
                        <button id="register-tab" class="px-6 py-2 font-semibold text-lg text-slate-500">Register</button>
                    </div>

                    <!-- Login Form -->
                    <form id="login-form" class="space-y-6">
                        <h2 class="text-2xl font-bold text-center">Welcome Back!</h2>
                        <div>
                            <label for="login-email" class="block text-sm font-medium text-slate-700">Email</label>
                            <input type="email" id="login-email" required class="mt-1 block w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-orange-400 focus:border-transparent">
                        </div>
                        <div>
                            <label for="login-password" class="block text-sm font-medium text-slate-700">Password</label>
                            <input type="password" id="login-password" required class="mt-1 block w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-orange-400 focus:border-transparent">
                        </div>
                        <button type="submit" class="w-full bg-orange-500 text-white font-bold py-3 rounded-md hover:bg-orange-600">Log In</button>
                        <div id="login-error" class="hidden text-red-600 text-sm text-center"></div>
                        <div id="login-success" class="hidden text-green-600 text-sm text-center"></div>
                    </form>

                    <!-- Register Form -->
                    <form id="register-form" class="hidden space-y-6">
                        <h2 class="text-2xl font-bold text-center">Create Your Account</h2>
                        
                        <!-- Basic Information -->
                        <div id="basic-info">
                            <div>
                                <label for="register-name" class="block text-sm font-medium text-slate-700">Full Name</label>
                                <input type="text" id="register-name" required class="mt-1 block w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-orange-400 focus:border-transparent">
                            </div>
                            <div class="mt-4">
                                <label for="register-email" class="block text-sm font-medium text-slate-700">Email</label>
                                <input type="email" id="register-email" required class="mt-1 block w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-orange-400 focus:border-transparent">
                            </div>
                            <div class="mt-4">
                                <label for="register-password" class="block text-sm font-medium text-slate-700">Password</label>
                                <input type="password" id="register-password" required minlength="6" class="mt-1 block w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-orange-400 focus:border-transparent">
                            </div>
                            <div class="mt-4">
                                <label for="register-role" class="block text-sm font-medium text-slate-700">Account Type</label>
                                <select id="register-role" class="mt-1 block w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-orange-400 focus:border-transparent">
                                    <option value="client">Client (Book Photographers)</option>
                                    <option value="photographer">Photographer (Offer Services)</option>
                                </select>
                            </div>
                            <div class="mt-4">
                                <label for="register-phone" class="block text-sm font-medium text-slate-700">Phone Number (Optional)</label>
                                <input type="tel" id="register-phone" class="mt-1 block w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-orange-400 focus:border-transparent">
                            </div>
                            
                            <!-- Cross-Device Sync Notice -->
                            <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                <div class="flex items-center">
                                    <svg class="w-5 h-5 text-blue-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <p class="text-sm text-blue-700">
                                        <strong>Cross-Device Sync:</strong> Your account will be saved to our cloud database and accessible from any device with internet connection.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Photographer Additional Info (Hidden by default) -->
                        <div id="photographer-info" class="hidden border-t pt-4">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                                <p class="text-sm font-semibold text-blue-800"> Photographer Account</p>
                                <p class="text-xs text-blue-600 mt-1">After creating your account, complete your profile from the dashboard to start receiving bookings.</p>
                            </div>
                        </div>

                        <button type="submit" class="w-full bg-slate-800 text-white font-bold py-3 rounded-md hover:bg-slate-700">Create Account</button>
                        <div id="register-error" class="hidden text-red-600 text-sm text-center"></div>
                        <div id="register-success" class="hidden text-green-600 text-sm text-center"></div>
                        <div id="register-info" class="hidden text-blue-600 text-sm text-center"></div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Client Booking Page -->
        <div id="book-photographer" class="page container mx-auto px-6 py-16">
            <div class="text-center mb-12">
                <h1 class="text-4xl font-bold font-serif-display">Book a Photographer</h1>
                <p class="text-lg text-slate-600 mt-2">Find and book the perfect photographer for your needs.</p>
            </div>

            <!-- Search and Filter Section -->
            <div class="mb-8 bg-white p-6 rounded-lg shadow-sm">
                <div class="grid md:grid-cols-4 gap-4">
                    <input type="text" id="search-photographer" placeholder="Search by name..." class="p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-orange-400 focus:border-transparent">
                    <select id="filter-specialty" class="p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-orange-400 focus:border-transparent">
                        <option value="">All Specialties</option>
                        <option value="weddings">Weddings</option>
                        <option value="portraits">Portraits</option>
                        <option value="events">Events</option>
                        <option value="commercial">Commercial</option>
                        <option value="fashion">Fashion</option>
                        <option value="nature">Nature</option>
                        <option value="street">Street</option>
                        <option value="sports">Sports</option>
                    </select>
                    <input type="text" id="filter-location" placeholder="Location (city)" class="p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-orange-400 focus:border-transparent">
                    <button onclick="searchPhotographers()" class="bg-orange-500 text-white font-bold py-3 px-6 rounded-md hover:bg-orange-600">Search</button>
                </div>
            </div>

            <!-- Photographer Results -->
            <div id="photographer-results" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Results will be populated by JavaScript -->
            </div>
        </div>

        <!-- Photographer Dashboard -->
        <div id="photographer-dashboard-page" class="page container mx-auto px-6 py-16">
            <div class="text-center mb-12">
                <h1 class="text-4xl font-bold font-serif-display">My Recent Bookings</h1>
                <p class="text-lg text-slate-600 mt-2">View and manage your photography bookings and client details.</p>
            </div>

            <div class="grid lg:grid-cols-4 gap-8">
                <!-- Profile Summary -->
                <div class="lg:col-span-1">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-bold mb-4">Profile Summary</h3>
                        <div id="dashboard-profile-info">
                            <!-- Will be populated by JavaScript -->
                        </div>
                        <button onclick="showPage('photographer-profile-edit')" class="w-full mt-4 bg-orange-500 text-white py-2 px-4 rounded-md hover:bg-orange-600">
                            Edit Profile
                        </button>
                    </div>

                    <!-- Profile Completion -->
                    <div id="profile-completion-card" class="mt-6 bg-white p-4 rounded-lg shadow-md hidden">
                        <h4 class="text-sm font-semibold text-slate-700 mb-2">Profile Completion</h4>
                        <div class="flex items-center gap-2 mb-3">
                            <div class="flex-1 bg-slate-200 rounded-full h-3 overflow-hidden">
                                <div id="completion-bar" class="h-3 rounded-full transition-all duration-500 bg-orange-500" style="width:0%"></div>
                            </div>
                            <span id="completion-percent" class="text-sm font-bold text-orange-600">0%</span>
                        </div>
                        <ul id="completion-checklist" class="space-y-1 text-xs text-slate-600"></ul>
                        <p class="text-xs text-slate-400 mt-2">Complete your profile to attract more clients.</p>
                    </div>

                    <!-- Quick Stats -->
                    <div class="mt-6 space-y-4">
                        <div class="bg-white p-4 rounded-lg shadow-md text-center">
                            <h4 class="text-sm font-semibold text-slate-600">Total Bookings</h4>
                            <p class="text-2xl font-bold text-orange-500" id="total-bookings">0</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-md text-center">
                            <h4 class="text-sm font-semibold text-slate-600">This Month</h4>
                            <p class="text-2xl font-bold text-orange-500" id="monthly-bookings">0</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-md text-center">
                            <h4 class="text-sm font-semibold text-slate-600">Portfolio Items</h4>
                            <p class="text-2xl font-bold text-orange-500" id="portfolio-count">0</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-md text-center">
                            <h4 class="text-sm font-semibold text-slate-600">Average Rating</h4>
                            <p class="text-2xl font-bold text-orange-500" id="average-rating">5.0</p>
                        </div>
                    </div>
                </div>

                <!-- Recent Bookings - Main Focus -->
                <div class="lg:col-span-3">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-bold mb-4">All Bookings & Client Details</h3>
                        <div id="dashboard-bookings">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Photographer Profile Edit -->
        <div id="photographer-profile-edit" class="page container mx-auto px-6 py-16">
            <div class="max-w-2xl mx-auto">
                <div class="bg-white p-8 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold mb-6">Edit Profile</h2>
                    <form id="photographer-profile-form" class="space-y-6">
                        
                        <!-- Profile Photo Section -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Profile Photo</label>
                            <div class="flex items-center space-x-4">
                                <div id="current-profile-image" class="w-20 h-20 rounded-full bg-slate-200 overflow-hidden flex-shrink-0">
                                    <!-- Current photo will be displayed here -->
                                </div>
                                <div class="flex-1">
                                    <input type="file" id="edit-profile-photo" accept="image/*" 
                                           onchange="previewEditProfileImage(this)"
                                           class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-orange-50 file:text-orange-700 hover:file:bg-orange-100">
                                    <p class="text-xs text-slate-500 mt-1">Upload a new profile photo (JPG, PNG - will be optimized)</p>
                                </div>
                            </div>
                            <div id="edit-profile-image-preview" class="mt-3"></div>
                        </div>
                        
                        <!-- Basic Info -->
                        <div>
                            <label for="edit-name" class="block text-sm font-medium text-slate-700">Full Name</label>
                            <input type="text" id="edit-name" class="mt-1 block w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-orange-400 focus:border-transparent">
                        </div>
                        
                        <div>
                            <label for="edit-bio" class="block text-sm font-medium text-slate-700">Bio</label>
                            <textarea id="edit-bio" rows="4" class="mt-1 block w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-orange-400 focus:border-transparent"></textarea>
                        </div>
                        
                        <div>
                            <label for="edit-location" class="block text-sm font-medium text-slate-700">Location</label>
                            <input type="text" id="edit-location" placeholder="City, State or Available for travel" class="mt-1 block w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-orange-400 focus:border-transparent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-3">Specialties</label>
                            <div id="edit-specialties-checkboxes" class="grid grid-cols-2 sm:grid-cols-3 gap-3 p-4 bg-slate-50 rounded-lg border">
                                <label class="flex items-center space-x-2 cursor-pointer p-2 rounded-md hover:bg-white transition-colors">
                                    <input type="checkbox" value="weddings" class="edit-specialty-checkbox text-orange-500 focus:ring-orange-400 rounded">
                                    <span class="text-sm text-slate-700">Weddings</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer p-2 rounded-md hover:bg-white transition-colors">
                                    <input type="checkbox" value="portraits" class="edit-specialty-checkbox text-orange-500 focus:ring-orange-400 rounded">
                                    <span class="text-sm text-slate-700">Portraits</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer p-2 rounded-md hover:bg-white transition-colors">
                                    <input type="checkbox" value="events" class="edit-specialty-checkbox text-orange-500 focus:ring-orange-400 rounded">
                                    <span class="text-sm text-slate-700">Events</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer p-2 rounded-md hover:bg-white transition-colors">
                                    <input type="checkbox" value="commercial" class="edit-specialty-checkbox text-orange-500 focus:ring-orange-400 rounded">
                                    <span class="text-sm text-slate-700">Commercial</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer p-2 rounded-md hover:bg-white transition-colors">
                                    <input type="checkbox" value="fashion" class="edit-specialty-checkbox text-orange-500 focus:ring-orange-400 rounded">
                                    <span class="text-sm text-slate-700">Fashion</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer p-2 rounded-md hover:bg-white transition-colors">
                                    <input type="checkbox" value="nature" class="edit-specialty-checkbox text-orange-500 focus:ring-orange-400 rounded">
                                    <span class="text-sm text-slate-700">Nature</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer p-2 rounded-md hover:bg-white transition-colors">
                                    <input type="checkbox" value="street" class="edit-specialty-checkbox text-orange-500 focus:ring-orange-400 rounded">
                                    <span class="text-sm text-slate-700">Street Photography</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer p-2 rounded-md hover:bg-white transition-colors">
                                    <input type="checkbox" value="sports" class="edit-specialty-checkbox text-orange-500 focus:ring-orange-400 rounded">
                                    <span class="text-sm text-slate-700">Sports</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer p-2 rounded-md hover:bg-white transition-colors">
                                    <input type="checkbox" value="architecture" class="edit-specialty-checkbox text-orange-500 focus:ring-orange-400 rounded">
                                    <span class="text-sm text-slate-700">Architecture</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer p-2 rounded-md hover:bg-white transition-colors">
                                    <input type="checkbox" value="landscape" class="edit-specialty-checkbox text-orange-500 focus:ring-orange-400 rounded">
                                    <span class="text-sm text-slate-700">Landscape</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer p-2 rounded-md hover:bg-white transition-colors">
                                    <input type="checkbox" value="other" class="edit-specialty-checkbox text-orange-500 focus:ring-orange-400 rounded">
                                    <span class="text-sm text-slate-700">Other</span>
                                </label>
                            </div>
                            <p class="text-xs text-slate-500 mt-2">Select all specialties that apply to your photography services</p>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="edit-hourly-rate" class="block text-sm font-medium text-slate-700">Hourly Rate ($)</label>
                                <input type="number" id="edit-hourly-rate" min="0" class="mt-1 block w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-orange-400 focus:border-transparent">
                            </div>
                            <div>
                                <label for="edit-experience" class="block text-sm font-medium text-slate-700">Years of Experience</label>
                                <input type="number" id="edit-experience" min="0" max="50" class="mt-1 block w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-orange-400 focus:border-transparent">
                            </div>
                        </div>

                        <!-- Backup Team -->
                        <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
                            <h4 class="text-sm font-semibold text-amber-800 mb-1">📋 Backup Team Agreement</h4>
                            <p class="text-xs text-amber-700 mb-3">If unexpectedly unavailable, you agree to send a qualified backup to the client in your place.</p>
                            <label for="edit-backup-count" class="block text-sm font-medium text-slate-700 mb-1">How many backup cameramen/videographers can you provide?</label>
                            <input type="number" id="edit-backup-count" min="0" max="20" placeholder="e.g. 2" class="mt-1 block w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-orange-400 focus:border-transparent">
                            <label class="flex items-start gap-2 mt-3 cursor-pointer">
                                <input type="checkbox" id="edit-backup-agree" class="mt-0.5 w-4 h-4 rounded border-amber-400 text-orange-500 focus:ring-orange-400">
                                <span class="text-xs text-amber-700">I agree to uphold the backup team policy &mdash; if I am unexpectedly unavailable I will arrange a qualified replacement for the client.</span>
                            </label>
                            <div class="mt-3">
                                <label class="block text-xs font-medium text-amber-800 mb-1">Upload Signed Agreement (optional)</label>
                                <input type="file" id="edit-agreement-file" accept=".pdf,.jpg,.jpeg,.png"
                                       class="block w-full text-xs text-slate-500 file:mr-3 file:py-1.5 file:px-3 file:rounded-md file:border-0 file:text-xs file:font-medium file:bg-amber-100 file:text-amber-800 hover:file:bg-amber-200 cursor-pointer">
                                <p class="text-xs text-amber-600 mt-1">Accepted: PDF, JPG, PNG</p>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Portfolio Management</label>
                            <div class="border-2 border-dashed border-slate-300 rounded-lg p-4">
                                <div class="mb-4">
                                    <h4 class="font-medium text-slate-700 mb-2">Current Portfolio Images</h4>
                                    <div id="current-portfolio-images" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 mb-4">
                                        <!-- Current portfolio images will be displayed here -->
                                    </div>
                                </div>
                                
                                <div>
                                    <label for="edit-portfolio-images" class="block text-sm font-medium text-slate-700 mb-2">Add New Portfolio Images</label>
                                    <input type="file" id="edit-portfolio-images" accept="image/*" multiple 
                                           onchange="previewEditPortfolioImages(this)"
                                           class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-orange-50 file:text-orange-700 hover:file:bg-orange-100">
                                    <p class="text-xs text-slate-500 mt-1">Upload up to 10 new portfolio images (JPG, PNG, WebP - will be optimized)</p>
                                    <div id="edit-portfolio-preview" class="mt-3 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Upload progress bar (shown during portfolio upload) -->
                        <div id="upload-progress-container" class="hidden mt-2 mb-2 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <div class="flex items-center justify-between mb-2">
                                <p id="upload-progress-text" class="text-sm font-semibold text-blue-700">Uploading photos...</p>
                                <span id="upload-progress-count" class="text-xs text-blue-600 font-medium"></span>
                            </div>
                            <div class="w-full bg-blue-200 rounded-full h-2.5 mb-3">
                                <div id="upload-progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width:0%"></div>
                            </div>
                            <div id="upload-progress-list" class="space-y-1 max-h-32 overflow-y-auto text-xs"></div>
                        </div>

                        <div class="flex gap-4">
                            <button type="submit" class="flex-1 bg-orange-500 text-white font-bold py-3 rounded-md hover:bg-orange-600">Save Changes</button>
                            <button type="button" onclick="showPage('photographer-dashboard-page')" class="flex-1 bg-slate-500 text-white font-bold py-3 rounded-md hover:bg-slate-600">Cancel</button>
                        </div>
                        <div id="profile-edit-error" class="hidden text-red-600 text-sm text-center"></div>
                        <div id="profile-edit-success" class="hidden text-green-600 text-sm text-center"></div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Admin Dashboard Page removed -->
        <div id="admin-dashboard-page" class="page hidden">
        </div>


    </main>

    <!-- Booking Modal -->
    <div id="booking-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-50 flex items-center justify-center p-2 sm:p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[95vh] overflow-y-auto mx-2 sm:mx-4">
            <!-- Modal Header -->
            <div class="bg-gradient-to-r from-blue-300 to-indigo-300 text-slate-800 p-6 rounded-t-xl">
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="text-2xl font-bold">ð€oe¸ Schedule Your Photography Session</h3>
                        <p class="text-slate-700 mt-1">Professional photography to capture your special moments</p>

                    </div>
                    <button onclick="closeBookingModal()" class="text-slate-700 hover:bg-white hover:bg-opacity-50 p-2 rounded-full transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <div id="booking-simple-view" class="booking-step">
                    <form id="simple-booking-form" class="space-y-4">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Date</label>
                                <input type="date" id="simple-date" class="w-full p-3 border border-slate-200 rounded-lg bg-slate-50 focus:ring-2 focus:ring-orange-400 focus:border-orange-400">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Time</label>
                                <select id="simple-time" class="w-full p-3 border border-slate-200 rounded-lg bg-slate-50 focus:ring-2 focus:ring-orange-400 focus:border-orange-400">
                                    <option value="">Select time...</option>
                                    <option value="06:00">6:00 AM</option>
                                    <option value="08:00">8:00 AM</option>
                                    <option value="10:00">10:00 AM</option>
                                    <option value="12:00">12:00 PM</option>
                                    <option value="14:00">2:00 PM</option>
                                    <option value="16:00">4:00 PM</option>
                                    <option value="18:00">6:00 PM</option>
                                    <option value="20:00">8:00 PM</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Session Type</label>
                            <select id="simple-session-type" class="w-full p-3 border border-slate-200 rounded-lg bg-slate-50 focus:ring-2 focus:ring-orange-400 focus:border-orange-400">
                                <option value="portrait">Portrait Session</option>
                                <option value="wedding">Wedding Photography</option>
                                <option value="event">Event Photography</option>
                                <option value="commercial">Commercial Shoot</option>
                                <option value="family">Family Photos</option>
                                <option value="nature">Nature &amp; Landscape</option>
                                <option value="fashion">Fashion Photography</option>
                                <option value="sports">Sports Photography</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Shoot Location</label>
                            <input type="text" id="simple-location" class="w-full p-3 border border-slate-200 rounded-lg bg-slate-50 focus:ring-2 focus:ring-orange-400 focus:border-orange-400" placeholder="e.g. Central Park, New York" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Special Requirements <span class="font-normal text-slate-400">(optional)</span></label>
                            <textarea id="simple-requirements" class="w-full p-3 border border-slate-200 rounded-lg bg-slate-50 focus:ring-2 focus:ring-orange-400 focus:border-orange-400 resize-none" rows="3" placeholder="Any specific requests or notes..."></textarea>
                        </div>
                        <div class="flex gap-3 pt-1">
                            <button type="button" onclick="closeBookingModal()" class="flex-1 py-3 border border-slate-300 text-slate-600 rounded-lg font-semibold hover:bg-slate-50 transition-colors">
                                Cancel
                            </button>
                            <button type="submit" class="flex-1 py-3 bg-orange-500 hover:bg-orange-600 text-white rounded-lg font-bold transition-colors shadow-sm">
                                Book Now
                            </button>
                        </div>
                    </form>
                </div>
                <!-- Step views (kept as hidden stubs for JS compatibility) -->
                <div id="booking-step-1" class="booking-step hidden"></div>
                <div id="booking-step-2" class="booking-step hidden"></div>
                <div id="booking-step-3" class="booking-step hidden"></div>

            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-slate-900 text-white">
        <div class="container mx-auto px-6 py-12">
            <div class="grid md:grid-cols-3 gap-8">
                <div>
                    <h3 class="text-xl font-bold font-serif-display mb-4">LensLink</h3>
                    <p class="text-slate-400">The modern way to book professional photography services.</p>
                </div>
                <div>
                    <h4 class="font-semibold mb-4">Quick Links</h4>
                    <ul class="space-y-2">
                        <li><a href="#" class="text-slate-400 hover:text-white" data-page="about">About Us</a></li>
                        <li><a href="#" class="text-slate-400 hover:text-white" data-page="contact">Contact</a></li>
                        <li><a href="#" class="text-slate-400 hover:text-white" data-page="login">My Account</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold mb-4">Contact</h4>
                    <p class="text-slate-400">saikumarreddyappidi9@gmail.com</p>
                    <p class="text-slate-400">8500079501</p>
                </div>
            </div>
            <div class="mt-8 pt-8 border-t border-slate-700 text-center text-slate-500 text-sm">
                <p>&copy; 2025 LensLink. All Rights Reserved to SaiKumarReddy.</p>
            </div>
        </div>
    </footer>

    <script>
        // API base â‚¬ always same-origin (server.js serves static files + API on the same port)
        const API_BASE_URL = '/api';
        let backendAvailable = false;
        
        // Test backend connection
        async function testBackendConnection() {
            try {
                console.log('ð€ Testing backend connection for cross-device sync...');
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 8000);
                const response = await fetch(`${API_BASE_URL}/health`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('â“ Backend Connected - Cross-device sync enabled:', result);
                backendAvailable = true;
                
                // Update UI to show backend status
                updateBackendStatus(true);
                return true;
            } catch (error) {
                console.warn('ï Backend unavailable - Cross-device sync disabled:', error.message);
                console.log('ð€oe± Accounts will only work on this device until backend is available');
                backendAvailable = false;
                updateBackendStatus(false);
                return false;
            }
        }
        
        // Update backend status in UI
        function updateBackendStatus(connected) {
            // Update the LocalStorage Database badge
            const badges = document.querySelectorAll('.bg-indigo-100');
            badges.forEach(badge => {
                if (badge.textContent.includes('LocalStorage')) {
                    badge.className = connected ? 'bg-green-100 text-green-800 text-sm font-medium px-3 py-1 rounded-full' : 'bg-indigo-100 text-indigo-800 text-sm font-medium px-3 py-1 rounded-full';
                    badge.textContent = connected ? 'Railway Cloud Database âoeï' : 'LocalStorage Database ð€™¾';
                }
            });
            
            // Update database description
            const descriptions = document.querySelectorAll('p');
            descriptions.forEach(p => {
                if (p.textContent.includes('Browser LocalStorage')) {
                    p.textContent = connected ? 
                        'Railway cloud database for cross-device authentication and data persistence' :
                        'MongoDB with Mongoose ODM â‚¬ persistent, cross-device storage for users, bookings, and photographer profiles';
                }
            });
        }
        
        // API Helper Function
        async function apiCall(endpoint, options = {}) {
            const token = localStorage.getItem('authToken');
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };
            
            if (token && endpoint !== '/health') {
                headers['Authorization'] = `Bearer ${token}`;
            }
            
            const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                ...options,
                headers
            });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                console.error('API Error:', response.status, errorData);
                throw new Error(errorData.message || `API Error: ${response.status}`);
            }
            
            return await response.json();
        }
        
        // Enhanced Authentication Functions
        async function registerUserWithBackend(userData) {
            try {
                const response = await apiCall('/auth/register', {
                    method: 'POST',
                    body: JSON.stringify(userData)
                });
                backendAvailable = true;
                return response;
            } catch (error) {
                console.error('Backend registration failed:', error);
                if (error.message.includes('already exists') || error.message.includes('duplicate')) {
                    throw new Error('An account with this email already exists');
                }
                throw new Error(error.message || 'Registration failed. Please try again.');
            }
        }
        
        async function loginUserWithBackend(credentials) {
            try {
                const response = await apiCall('/auth/login', {
                    method: 'POST',
                    body: JSON.stringify(credentials)
                });
                backendAvailable = true;
                localStorage.setItem('authToken', response.token);
                currentUser = response.user;

                // For photographers, load full profile data (bio, hourlyRate, specialties, etc.)
                if (currentUser && currentUser.role === 'photographer') {
                    try {
                        const profiles = await fetch(`${API_BASE_URL}/photographers?limit=100`);
                        const data = await profiles.json();
                        if (data.success) {
                            const myProfile = data.photographers.find(p => p.user && p.user._id === currentUser._id || p.user && p.user._id === currentUser.id);
                            if (myProfile) {
                                currentUser._photographerId = myProfile._id;
                                currentUser.bio = myProfile.bio || '';
                                currentUser.specialties = myProfile.specialties || [];
                                currentUser.hourlyRate = myProfile.pricing ? myProfile.pricing.hourlyRate : 150;
                                currentUser.location = myProfile.location
                                    ? [myProfile.location.city, myProfile.location.state].filter(Boolean).join(', ')
                                    : '';
                                const rawImg = myProfile.profilePhoto || '';
                                if (rawImg && (rawImg.startsWith('http') || rawImg.startsWith('data:'))) {
                                    currentUser.profileImage = rawImg;
                                }
                                currentUser.portfolio = myProfile.portfolio || [];
                                console.log('â“ Photographer profile loaded', myProfile._id);
                            }
                        }
                    } catch(pe) { console.warn('Could not load photographer profile:', pe.message); }
                }

                localStorage.setItem(STORAGE_KEYS.currentUser, JSON.stringify(currentUser));
                return response;
            } catch (error) {
                console.error('Backend login failed:', error);
                throw new Error(error.message || 'Invalid email or password. Please check your credentials.');
            }
        }
        
        // Initialize backend connection on page load - MOVED TO MAIN DOMContentLoaded
        // document.addEventListener('DOMContentLoaded', function() {
        //     testBackendConnection();
        // });
        
        // Local Storage Configuration (Enhanced with Backend Integration)
        const STORAGE_KEYS = {
            users: 'lenslink_users',
            currentUser: 'lenslink_current_user',
            photographers: 'lenslink_photographers'
        };
        
        // State Management
        let currentUser = null;
        let allUsers = [];
        let allPhotographers = [];

        // Global Page Navigation Function - Make globally accessible
        window.showPage = function(pageId) {
            console.log('ð€oe Navigating to page:', pageId);
            
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => {
                page.classList.remove('active');
            });
            const activePage = document.getElementById(pageId);
            if (activePage) {
                activePage.classList.add('active');
                window.scrollTo(0, 0);
                console.log('â“ Page activated:', pageId);
            } else {
                console.error(' Page not found:', pageId);
            }
            
            // Load specific page data
            setTimeout(() => {
                if (pageId === 'find-photographers') {
                    loadRegisteredPhotographers();
                } else if (pageId === 'book-photographer') {
                    loadRegisteredPhotographers().then(() => displayPhotographersInBookingPage(allPhotographers));
                } else if (pageId === 'photographer-dashboard-page') {
                    if (currentUser && currentUser.role === 'photographer') {
                        loadPhotographerDashboard();
                    }
                }
            }, 100);
        }

        // Load data from localStorage
        function loadFromLocalStorage() {
            allUsers = JSON.parse(localStorage.getItem(STORAGE_KEYS.users) || '[]');
            allPhotographers = JSON.parse(localStorage.getItem(STORAGE_KEYS.photographers) || '[]');
            const savedUser = localStorage.getItem(STORAGE_KEYS.currentUser);
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
            }
        }

        // Save data to localStorage
        function saveToLocalStorage() {
            try {
                console.log('ð€™¾ Attempting to save to localStorage...');
                
                // Check if localStorage is available
                if (typeof Storage === "undefined") {
                    throw new Error('LocalStorage is not supported in this browser');
                }
                
                // Save users
                console.log('ð€™¾ Saving users:', allUsers.length, 'users');
                localStorage.setItem(STORAGE_KEYS.users, JSON.stringify(allUsers));
                
                // Save photographers  
                console.log('ð€™¾ Saving photographers:', allPhotographers.length, 'photographers');
                localStorage.setItem(STORAGE_KEYS.photographers, JSON.stringify(allPhotographers));
                
                // Save current user
                if (currentUser) {
                    console.log('ð€™¾ Saving current user:', currentUser.name);
                    localStorage.setItem(STORAGE_KEYS.currentUser, JSON.stringify(currentUser));
                }
                
                console.log('â“ Successfully saved all data to localStorage');
                return true;
                
            } catch (error) {
                console.error(' Failed to save to localStorage:', error);
                
                // Check for storage quota exceeded
                if (error.name === 'QuotaExceededError' || error.code === 22) {
                    console.error(' Storage quota exceeded - try clearing browser data');
                    throw new Error('Storage quota exceeded. Please clear browser data and try again.');
                }
                
                throw error;
            }
        }

        // DOM Elements
        const authButtons = document.getElementById('auth-buttons');
        const userMenu = document.getElementById('user-menu');
        const userWelcome = document.getElementById('user-welcome');
        const userName = document.getElementById('user-name');
        const userAvatar = document.getElementById('user-avatar');
        const photographerMenu = document.getElementById('photographer-menu');

        // Global Page Navigation Function - Make globally accessible
        window.showPage = function(pageId) {
            console.log('ð€oe Navigating to page:', pageId);
            
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => {
                page.classList.remove('active');
            });
            const activePage = document.getElementById(pageId);
            if (activePage) {
                activePage.classList.add('active');
                window.scrollTo(0, 0);
                console.log('â“ Page activated:', pageId);
            } else {
                console.error(' Page not found:', pageId);
            }
            
            // Load specific page data
            setTimeout(() => {
                if (pageId === 'find-photographers') {
                    loadRegisteredPhotographers();
                } else if (pageId === 'book-photographer') {
                    loadRegisteredPhotographers().then(() => {
                        displayPhotographersInBookingPage(allPhotographers);
                    });
                } else if (pageId === 'photographer-dashboard-page') {
                    if (currentUser && currentUser.role === 'photographer') {
                        loadPhotographerDashboard();
                    }
                } else if (pageId === 'user-profile') {
                    displayUserProfile();
                } else if (pageId === 'login') {
                    // Ensure login form is set up properly
                    initializeLoginPage();
                } else if (pageId === 'photographer-profile-edit') {
                    // Initialize edit profile page with current user data
                    console.log('🎨 Attempting to initialize edit profile page');
                    if (typeof initializeEditProfile === 'function') {
                        initializeEditProfile();
                    } else {
                        console.error(' initializeEditProfile function not found');
                        // Try alternative approach
                        setTimeout(() => {
                            if (window.initializeEditProfile) {
                                window.initializeEditProfile();
                            } else {
                                console.log('ð€ Manually initializing edit profile');
                                manuallyInitializeEditProfile();
                            }
                        }, 100);
                    }
                }
            }, 100);
        }

        // Authentication Functions (Enhanced with Backend Integration) - MOVED BEFORE DOMContentLoaded
        async function handleLogin(e) {
            e.preventDefault();
            
            const emailInput = document.getElementById('login-email');
            const passwordInput = document.getElementById('login-password');
            
            if (!emailInput || !passwordInput) {
                console.error('Login form inputs not found');
                return;
            }
            
            const email = emailInput.value;
            const password = passwordInput.value;
            
            // Basic validation
            if (!email.trim()) {
                showMessage('login-error', 'Please enter your email address', 'error');
                return;
            }
            
            if (!password.trim()) {
                showMessage('login-error', 'Please enter your password', 'error');
                return;
            }
            
            clearMessages();
            showLoading('login-form', true);

            try {
                let loginSuccessful = false;
                
                // ALWAYS try backend first (force backend usage for cross-device sync)
                console.log('ð€ Attempting backend login for cross-device sync...');
                try {
                    const result = await loginUserWithBackend({ email, password });
                    if (result.success) {
                        currentUser = result.user;
                        localStorage.setItem(STORAGE_KEYS.currentUser, JSON.stringify(currentUser));
                        localStorage.setItem('authToken', result.token);
                        loginSuccessful = true;
                        console.log('â“ Backend login successful - Account synced across devices');
                        
                        // Also update localStorage with backend data for offline fallback
                        loadFromLocalStorage();
                        const existingUserIndex = allUsers.findIndex(u => u.email.toLowerCase() === email.toLowerCase());
                        if (existingUserIndex >= 0) {
                            allUsers[existingUserIndex] = result.user;
                        } else {
                            allUsers.push(result.user);
                        }
                        saveToLocalStorage();
                    }
                } catch (error) {
                    console.log('ï Backend login failed, trying localStorage:', error.message);
                }
                
                // Fallback to localStorage if backend fails
                if (!loginSuccessful) {
                    loadFromLocalStorage();
                    const user = allUsers.find(u => u.email.toLowerCase() === email.toLowerCase());
                    
                    if (user && user.password === password) {
                        currentUser = user;
                        localStorage.setItem(STORAGE_KEYS.currentUser, JSON.stringify(currentUser));
                        loginSuccessful = true;
                        console.log('â“ localStorage login successful');
                    }
                }
                
                if (loginSuccessful) {
                    showMessage('login-success', 'Login successful! Redirecting...', 'success');
                    
                    // Send welcome email using EmailJS
                    if (window.sendWelcomeEmail && currentUser) {
                        sendWelcomeEmail(currentUser.email, currentUser.name, currentUser.role);
                    }
                    
                    setTimeout(() => {
                        updateUI();
                        
                        // Clear form
                        emailInput.value = '';
                        passwordInput.value = '';
                        
                        if (currentUser.role === 'photographer') {
                            showPage('photographer-dashboard-page');
                            loadPhotographerDashboard();
                        } else {
                            showPage('find-photographers');
                            loadRegisteredPhotographers();
                        }
                    }, 1000);
                } else {
                    showMessage('login-error', 'Invalid email or password', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showMessage('login-error', 'Login failed. Please try again.', 'error');
            } finally {
                showLoading('login-form', false);
            }
        }

        // Register function
        async function handleRegister(e) {
            e.preventDefault();
            console.log('‚¬ Register function called');
            
            // Get form values
            const name = document.getElementById('register-name')?.value;
            const email = document.getElementById('register-email')?.value;
            const password = document.getElementById('register-password')?.value;
            const role = document.getElementById('register-role')?.value;
            const phone = document.getElementById('register-phone')?.value;
            
            // Basic validation
            if (!name || !email || !password || !role) {
                showMessage('register-error', 'Please fill in all required fields', 'error');
                return;
            }
            
            if (password.length < 6) {
                showMessage('register-error', 'Password must be at least 6 characters long', 'error');
                return;
            }
            
            clearMessages();
            showLoading('register-form', true);
            
            try {
                let registrationSuccessful = false;
                let newUser = null;
                
                // Create user object
                const userData = {
                    name,
                    email,
                    password,
                    role,
                    phone
                };
                
                // Add photographer-specific fields
                if (role === 'photographer') {
                    userData.specialties = ['Portrait', 'Wedding']; // defaults â‚¬ can edit in Profile
                    userData.portfolio = [];
                    userData.backupCount = parseInt(document.getElementById('register-backup-count')?.value || '0');
                }
                
                // Send registration directly to backend
                console.log('ð€ Attempting backend registration...');
                showMessage('register-info', 'ð€oe¡ Creating your account... Please wait.', 'info');

                try {
                    const result = await registerUserWithBackend(userData);
                    if (result.success) {
                        newUser = result.user;
                        localStorage.setItem('authToken', result.token);
                        registrationSuccessful = true;
                        backendAvailable = true;
                        console.log('â“ Backend registration successful');
                        showMessage('register-success', 'â“ Account created! Please check your email to verify your address.', 'success');
                    }
                } catch (error) {
                    console.error(' Backend registration failed:', error.message);
                    if (error.message.includes('already exists') || error.message.includes('duplicate')) {
                        showMessage('register-error', ' An account with this email already exists. Try logging in instead.', 'error');
                    } else if (error.message.includes('fetch') || error.message.includes('network') || error.message.includes('Failed to fetch')) {
                        showMessage('register-error', ' Cannot reach the server. Make sure the server is running on port 3000.', 'error');
                    } else {
                        showMessage('register-error', ` Registration failed: ${error.message}`, 'error');
                    }
                    return;
                }
                
                // NO FALLBACK - Force backend usage for cross-device sync
                // Removed localStorage fallback to ensure all accounts go to MongoDB database
                
                if (registrationSuccessful) {
                    currentUser = newUser;
                    localStorage.setItem(STORAGE_KEYS.currentUser, JSON.stringify(currentUser));
                }
                
                showMessage('register-success', 'Registration successful! Redirecting...', 'success');
                
                setTimeout(() => {
                    updateUI();
                    
                    if (role === 'photographer') {
                        showPage('photographer-dashboard-page');
                        loadPhotographerDashboard();
                    } else {
                        showPage('find-photographers');
                        loadRegisteredPhotographers();
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Registration error:', error);
                showMessage('register-error', 'Registration failed. Please try again.', 'error');
            } finally {
                showLoading('register-form', false);
            }
        }

        // Make functions globally accessible
        window.handleLogin = handleLogin;
        window.handleRegister = handleRegister;

        document.addEventListener('DOMContentLoaded', async function() {
            console.log('✅ DOM Content Loaded - Initializing LensLink');

            // --- Page Navigation (set up FIRST so buttons work immediately) ---
            document.querySelectorAll('a[data-page]').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const pageId = link.getAttribute('data-page');
                    showPage(pageId);
                    const mobileMenu = document.getElementById('mobile-menu');
                    if (mobileMenu && !mobileMenu.classList.contains('hidden')) {
                        mobileMenu.classList.add('hidden');
                    }
                });
            });

            // --- Mobile Menu (also set up immediately) ---
            const _mobileMenuButton = document.getElementById('mobile-menu-button');
            const _mobileMenu = document.getElementById('mobile-menu');
            if (_mobileMenuButton && _mobileMenu) {
                _mobileMenuButton.addEventListener('click', () => {
                    _mobileMenu.classList.toggle('hidden');
                });
            }

            // Test backend connection with retry for cross-device sync
            await testBackendConnection();
            
            // If backend failed, retry after 3 seconds
            if (!backendAvailable) {
                console.log('ð€ Retrying backend connection in 3 seconds...');
                setTimeout(async () => {
                    await testBackendConnection();
                    if (!backendAvailable) {
                        console.log('ð€ Final retry in 10 seconds...');
                        setTimeout(testBackendConnection, 10000);
                    }
                }, 3000);
            }
            
            // Load data from localStorage first
            loadFromLocalStorage();
            
            // Initialize sample data if none exists
            initializeSampleData();
            
            // Initialize the app
            try {
                await initializeApp();
                console.log('â“ App initialized successfully');
            } catch (error) {
                console.error(' App initialization failed:', error);
            }
            
            // Email-verified toast: triggered after clicking the verification link
            (function checkVerifiedParam() {
                const params = new URLSearchParams(window.location.search);
                if (params.get('verified') === 'true') {
                    const name = params.get('name') ? decodeURIComponent(params.get('name')) : '';
                    const toast = document.createElement('div');
                    toast.innerHTML = `<span style="font-size:1.2em">â“</span> &nbsp;Email verified! Welcome to LensLink${name ? ', ' + name : ''}. You can now log in.`;
                    Object.assign(toast.style, {
                        position: 'fixed', top: '1.25rem', left: '50%', transform: 'translateX(-50%)',
                        background: '#16a34a', color: '#fff', padding: '0.85rem 1.6rem',
                        borderRadius: '0.5rem', fontWeight: '600', zIndex: '9999',
                        boxShadow: '0 4px 14px rgba(0,0,0,0.18)', transition: 'opacity 0.5s'
                    });
                    document.body.appendChild(toast);
                    setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 500); }, 5000);
                    // Clean the URL without reloading
                    window.history.replaceState({}, '', window.location.pathname);
                }
            })();

            // Contact / Feedback Form â‚¬ uses backend /api/feedback
            const contactForm = document.getElementById('contact-form');
            if (contactForm) {
                contactForm.addEventListener('submit', async function(e) {
                    e.preventDefault();

                    const submitBtn   = document.getElementById('contact-submit-btn');
                    const successDiv  = document.getElementById('contact-success');
                    const errorDiv    = document.getElementById('contact-error');

                    successDiv.classList.add('hidden');
                    errorDiv.classList.add('hidden');
                    submitBtn.disabled    = true;
                    submitBtn.textContent = 'Sending...';

                    const payload = {
                        name   : document.getElementById('contact-name').value.trim(),
                        email  : document.getElementById('contact-email').value.trim(),
                        subject: (document.getElementById('contact-subject')?.value || '').trim() || 'General Enquiry',
                        message: document.getElementById('contact-message').value.trim(),
                    };

                    try {
                        const response = await fetch('/api/feedback', {
                            method : 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body   : JSON.stringify(payload),
                        });

                        const result = await response.json();

                        if (result.success) {
                            successDiv.textContent = '\u2705 ' + result.message;
                            successDiv.classList.remove('hidden');
                            contactForm.reset();
                        } else {
                            throw new Error(result.message || 'Failed to send message');
                        }
                    } catch (err) {
                        console.error('Contact form error:', err);
                        errorDiv.textContent = '\u274c ' + (err.message || 'Failed to send message. Please try again.');
                        errorDiv.classList.remove('hidden');
                    } finally {
                        submitBtn.disabled    = false;
                        submitBtn.textContent = 'Send Message';
                    }
                });
                console.log('\u2705 Contact form â€  /api/feedback handler initialized');
            }
            
            console.log('ð€oeŠ Loaded users:', allUsers.length, 'photographers:', allPhotographers.length);
            
            // Debug button functionality
            console.log('ð€ Checking button functionality...');
            console.log('ð€oe Navigation links found:', document.querySelectorAll('a[data-page]').length);
            
            // Test key buttons
            const loginBtnTest = document.querySelector('a[data-page="login"]');
            const mobileMenuBtnTest = document.getElementById('mobile-menu-button');
            
            console.log('ð€Ëoe Key buttons status:', {
                loginBtn: !!loginBtnTest,
                mobileMenuBtn: !!mobileMenuBtnTest
            });
            
            // DISABLED: Emergency backup registration function uses localStorage fallback
            // This causes cross-device sync issues - ALL registrations MUST go through backend
            /*
            window.handleRegisterBackup = function(e) {
                e.preventDefault();
                console.log('ð€ Ëoe Using backup registration function');
                
                const name = document.getElementById('register-name').value;
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const role = document.getElementById('register-role').value;
                const phone = document.getElementById('register-phone').value;
                
                if (!name || !email || !password) {
                    alert('Please fill in all required fields');
                    return;
                }
                
                // Check if user exists
                if (allUsers.find(u => u.email === email)) {
                    alert('Email already registered');
                    return;
                }
                
                // Handle profile image
                let profileImage = `https://placehold.co/100x100/94a3b8/ffffff?text=${name.charAt(0)}`;
                const photoInput = document.getElementById('register-profile-photo');
                if (photoInput && photoInput.compressedImage) {
                    profileImage = photoInput.compressedImage;
                    console.log('â“ Using compressed profile image from backup function');
                }
                
                const newUser = {
                    id: 'user_' + Date.now(),
                    name, email, password, role, phone,
                    profileImage: profileImage
                };
                
                if (role === 'photographer') {
                    const hourlyRate = document.getElementById('register-hourly-rate').value;
                    const experience = document.getElementById('register-experience').value;
                    
                    newUser.bio = document.getElementById('register-bio').value || 'Professional photographer';
                    newUser.specialties = ['portraits'];
                    newUser.hourlyRate = hourlyRate ? parseInt(hourlyRate) : 150;
                    newUser.experience = experience ? parseInt(experience) : 1;
                    newUser.location = document.getElementById('register-location').value || 'Available for travel';
                    
                    // Handle portfolio images from global portfolioImages array
                    try {
                        newUser.portfolio = portfolioImages && portfolioImages.length > 0 
                            ? portfolioImages.map(img => ({
                                name: img.name,
                                data: img.compressedData,
                                uploadDate: new Date().toISOString()
                            }))
                            : [];
                        console.log('â“ Added portfolio images to backup registration:', newUser.portfolio.length, 'images');
                    } catch (error) {
                        console.warn('ï Portfolio processing failed in backup function:', error);
                        newUser.portfolio = [];
                    }
                    
                    allPhotographers.push(newUser);
                }
                
                allUsers.push(newUser);
                currentUser = newUser;
                saveToLocalStorage();
                
                alert('Registration successful!');
                updateUI();
                showPage(role === 'photographer' ? 'photographer-dashboard-page' : 'find-photographers');
            };
            */
            
            // Add emergency backup for login function
            window.handleLoginBackup = function(e) {
                e.preventDefault();
                console.log('ð€ Ëoe Using backup login function');
                
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                
                if (!email || !password) {
                    alert('Please enter email and password');
                    return;
                }
                
                const user = allUsers.find(u => u.email.toLowerCase() === email.toLowerCase() && u.password === password);
                
                if (user) {
                    currentUser = user;
                    localStorage.setItem(STORAGE_KEYS.currentUser, JSON.stringify(currentUser));
                    
                    // Send welcome email using EmailJS
                    if (window.sendWelcomeEmail) {
                        sendWelcomeEmail(user.email, user.name, user.role);
                    }
                    
                    alert('Login successful!');
                    updateUI();
                    showPage(user.role === 'photographer' ? 'photographer-dashboard-page' : 'find-photographers');
                } else {
                    alert('Invalid email or password');
                }
            };

            // --- Page Navigation & Mobile Menu already set up at top of DOMContentLoaded ---

            // --- User Menu Dropdown ---
            const userMenuButton = document.getElementById('user-menu-button');
            const userDropdown = document.getElementById('user-dropdown');
            if (userMenuButton && userDropdown) {
                userMenuButton.addEventListener('click', () => {
                    userDropdown.classList.toggle('hidden');
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!userMenuButton.contains(e.target) && !userDropdown.contains(e.target)) {
                        userDropdown.classList.add('hidden');
                    }
                });
            }

            // --- Login/Register Tabs ---
            const loginTab = document.getElementById('login-tab');
            const registerTab = document.getElementById('register-tab');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const registerRole = document.getElementById('register-role');
            const photographerInfo = document.getElementById('photographer-info');

            console.log('ð€ Login/Register elements found:', {
                loginTab: !!loginTab,
                registerTab: !!registerTab, 
                loginForm: !!loginForm,
                registerForm: !!registerForm
            });

            if(loginTab && registerTab && loginForm && registerForm){
                // Show/hide photographer fields based on role selection
                if (registerRole && photographerInfo) {
                    registerRole.addEventListener('change', function() {
                        if (this.value === 'photographer') {
                            photographerInfo.classList.remove('hidden');
                        } else {
                            photographerInfo.classList.add('hidden');
                        }
                    });
                }

                loginTab.addEventListener('click', () => {
                    console.log('ð€oe Login tab clicked');
                    loginTab.classList.add('border-orange-500', 'text-orange-500', 'border-b-2');
                    loginTab.classList.remove('text-slate-500');
                    registerTab.classList.remove('border-orange-500', 'text-orange-500', 'border-b-2');
                    registerTab.classList.add('text-slate-500');
                    const adminTabEl = document.getElementById('admin-tab');
                    if (adminTabEl) {
                        adminTabEl.classList.remove('border-orange-500', 'text-orange-500', 'border-b-2');
                        adminTabEl.classList.add('text-slate-500');
                    }
                    loginForm.classList.remove('hidden');
                    loginForm.style.display = 'block';
                    registerForm.classList.add('hidden');
                    registerForm.style.display = 'none';
                    const adminFormEl = document.getElementById('admin-login-form');
                    if (adminFormEl) adminFormEl.classList.add('hidden');
                    clearMessages();
                });

                registerTab.addEventListener('click', () => {
                    console.log('ð€oe Register tab clicked');
                    registerTab.classList.add('border-orange-500', 'text-orange-500', 'border-b-2');
                    registerTab.classList.remove('text-slate-500');
                    loginTab.classList.remove('border-orange-500', 'text-orange-500', 'border-b-2');
                    loginTab.classList.add('text-slate-500');
                    const adminTabEl = document.getElementById('admin-tab');
                    if (adminTabEl) {
                        adminTabEl.classList.remove('border-orange-500', 'text-orange-500', 'border-b-2');
                        adminTabEl.classList.add('text-slate-500');
                    }
                    loginForm.classList.add('hidden');
                    loginForm.style.display = 'none';
                    registerForm.classList.remove('hidden');
                    registerForm.style.display = 'block';
                    const adminFormEl = document.getElementById('admin-login-form');
                    if (adminFormEl) adminFormEl.classList.add('hidden');
                    clearMessages();
                });

                // Login Form Handler - Ensure it's always attached
                console.log('ð€ Attaching login form handler');
                loginForm.removeEventListener('submit', handleLogin); // Remove any existing listener
                try {
                    loginForm.addEventListener('submit', handleLogin);
                } catch (error) {
                    console.warn('ï Main login handler failed, using backup');
                    loginForm.addEventListener('submit', handleLoginBackup);
                }

                // Register Form Handler - Ensure it's always attached  
                console.log('ð€ Attaching register form handler');
                registerForm.removeEventListener('submit', handleRegister); // Remove any existing listener
                registerForm.addEventListener('submit', handleRegister);
                console.log('â“ Register form handler attached - NO localStorage fallback for cross-device sync');
                
                console.log('â“ Login/Register forms initialized successfully');
            } else {
                console.error(' Login/Register form elements not found');
            }

            // --- User Menu Actions ---
            const myBookings = document.getElementById('my-bookings');
            const myProfile = document.getElementById('my-profile');
            const myRecentBookings = document.getElementById('my-recent-bookings');
            const findPhotographersLink = document.getElementById('find-photographers-link');

            if (myBookings) {
                myBookings.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (currentUser && currentUser.role === 'client') {
                        showPage('book-photographer');
                    } else {
                        showPage('photographer-dashboard-page');
                    }
                });
            }

            if (findPhotographersLink) {
                findPhotographersLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    showPage('find-photographers');
                    loadRegisteredPhotographers();
                });
            }

            if (myRecentBookings) {
                myRecentBookings.addEventListener('click', (e) => {
                    e.preventDefault();
                    showPage('photographer-dashboard-page');
                    setTimeout(() => {
                        loadPhotographerDashboard();
                    }, 100);
                });
            }

            if (myProfile) {
                myProfile.addEventListener('click', (e) => {
                    e.preventDefault();
                    showPage('user-profile');
                    displayUserProfile();
                });
            }

            // --- Photographer Profile Form ---
            const photographerProfileForm = document.getElementById('photographer-profile-form');
            if (photographerProfileForm) {
                photographerProfileForm.addEventListener('submit', handlePhotographerProfileUpdate);
            }

            // --- Logout Handler ---
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    handleLogout();
                });
            }

            // --- Datepicker for Profile Page ---
            const datepickerEl = document.getElementById('datepicker');
            if (datepickerEl) {
                // Get some dates to disable for demonstration
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const dayAfter = new Date();
                dayAfter.setDate(dayAfter.getDate() + 4);

                flatpickr(datepickerEl, {
                    inline: true,
                    minDate: "today",
                    dateFormat: "Y-m-d",
                    disable: [tomorrow, dayAfter], // Example of disabled dates
                    onChange: function(selectedDates, dateStr, instance) {
                        const bookingDateInput = document.getElementById('booking-date');
                        if (bookingDateInput) {
                            bookingDateInput.value = dateStr;
                        }
                    }
                });
            }
            
            // Set initial page
            showPage('home');
            
            // Load photographers on home page
            loadPhotographers();
            
            // Check for current user and update UI
            if (currentUser) {
                updateUI();
            }
            
            // Make edit profile functions globally accessible
            window.initializeEditProfile = initializeEditProfile;
            window.manuallyInitializeEditProfile = manuallyInitializeEditProfile;
        });

        // --- Local Storage Functions (No API needed) ---
        function initializeSampleData() {
            // Add sample photographers if none exist
            if (allPhotographers.length === 0) {
                const samplePhotographers = [
                    {
                        id: 'photo1',
                        name: 'Jane Doe',
                        email: 'jane@example.com',
                        password: 'password123',
                        role: 'photographer',
                        specialties: ['weddings', 'portraits'],
                        bio: 'Professional wedding and portrait photographer with 10+ years experience. Specializing in capturing timeless moments.',
                        hourlyRate: 200,
                        experience: 10,
                        location: 'New York, NY',
                        profileImage: 'https://placehold.co/400x400/a78bfa/ffffff?text=Jane+Doe',
                        portfolio: [
                            'https://placehold.co/600x400/fefce8/a16207?text=Wedding+1',
                            'https://placehold.co/600x400/ecfccb/4d7c0f?text=Wedding+2',
                            'https://placehold.co/600x400/f0f9ff/0ea5e9?text=Portrait+1',
                            'https://placehold.co/600x400/fef2f2/be123c?text=Portrait+2'
                        ]
                    },
                    {
                        id: 'photo2',
                        name: 'John Smith',
                        email: 'john@example.com',
                        password: 'password123',
                        role: 'photographer',
                        specialties: ['events', 'commercial'],
                        bio: 'Event and commercial photographer specializing in corporate events and brand photography.',
                        hourlyRate: 150,
                        experience: 8,
                        location: 'Los Angeles, CA',
                        profileImage: 'https://placehold.co/400x400/f87171/ffffff?text=John+Smith',
                        portfolio: [
                            'https://placehold.co/600x400/f0f9ff/0ea5e9?text=Event+1',
                            'https://placehold.co/600x400/fef2f2/be123c?text=Commercial+1',
                            'https://placehold.co/600x400/ecfccb/4d7c0f?text=Event+2',
                            'https://placehold.co/600x400/fefce8/a16207?text=Commercial+2'
                        ]
                    },
                    {
                        id: 'photo3',
                        name: 'Emily White',
                        email: 'emily@example.com',
                        password: 'password123',
                        role: 'photographer',
                        specialties: ['portraits', 'family'],
                        bio: 'Family and lifestyle photographer capturing authentic moments and connections.',
                        hourlyRate: 180,
                        experience: 6,
                        location: 'Chicago, IL',
                        profileImage: 'https://placehold.co/400x400/60a5fa/ffffff?text=Emily+White',
                        portfolio: [
                            'https://placehold.co/600x400/ecfccb/4d7c0f?text=Family+1',
                            'https://placehold.co/600x400/fefce8/a16207?text=Portrait+1',
                            'https://placehold.co/600x400/f0f9ff/0ea5e9?text=Family+2',
                            'https://placehold.co/600x400/fef2f2/be123c?text=Portrait+2'
                        ]
                    },
                    {
                        id: 'photo4',
                        name: 'Michael Johnson',
                        email: 'michael@example.com',
                        password: 'password123',
                        role: 'photographer',
                        specialties: ['nature', 'landscape'],
                        bio: 'Nature and landscape photographer with expertise in outdoor photography and adventure shoots.',
                        hourlyRate: 170,
                        experience: 12,
                        location: 'Denver, CO',
                        profileImage: 'https://placehold.co/400x400/34d399/ffffff?text=Michael+J',
                        portfolio: [
                            'https://placehold.co/600x400/ecfccb/4d7c0f?text=Nature+1',
                            'https://placehold.co/600x400/fefce8/a16207?text=Landscape+1',
                            'https://placehold.co/600x400/f0f9ff/0ea5e9?text=Nature+2',
                            'https://placehold.co/600x400/fef2f2/be123c?text=Landscape+2'
                        ]
                    },
                    {
                        id: 'photo5',
                        name: 'Sarah Davis',
                        email: 'sarah@example.com',
                        password: 'password123',
                        role: 'photographer',
                        specialties: ['fashion', 'portraits'],
                        bio: 'Fashion and portrait photographer creating stunning editorial and commercial images.',
                        hourlyRate: 250,
                        experience: 9,
                        location: 'Miami, FL',
                        profileImage: 'https://placehold.co/400x400/f472b6/ffffff?text=Sarah+D',
                        portfolio: [
                            'https://placehold.co/600x400/fefce8/a16207?text=Fashion+1',
                            'https://placehold.co/600x400/ecfccb/4d7c0f?text=Fashion+2',
                            'https://placehold.co/600x400/f0f9ff/0ea5e9?text=Portrait+1',
                            'https://placehold.co/600x400/fef2f2/be123c?text=Portrait+2'
                        ]
                    },
                    {
                        id: 'photo6',
                        name: 'David Wilson',
                        email: 'david@example.com',
                        password: 'password123',
                        role: 'photographer',
                        specialties: ['sports', 'action'],
                        bio: 'Sports and action photographer capturing dynamic moments in athletic events.',
                        hourlyRate: 190,
                        experience: 7,
                        location: 'Austin, TX',
                        profileImage: 'https://placehold.co/400x400/ef4444/ffffff?text=David+W',
                        portfolio: [
                            'https://placehold.co/600x400/ecfccb/4d7c0f?text=Sports+1',
                            'https://placehold.co/600x400/fefce8/a16207?text=Action+1',
                            'https://placehold.co/600x400/f0f9ff/0ea5e9?text=Sports+2',
                            'https://placehold.co/600x400/fef2f2/be123c?text=Action+2'
                        ]
                    },
                    {
                        id: 'photo7',
                        name: 'Lisa Chen',
                        email: 'lisa@example.com',
                        password: 'password123',
                        role: 'photographer',
                        specialties: ['weddings', 'events'],
                        bio: 'Wedding and event photographer specializing in cultural celebrations and intimate ceremonies.',
                        hourlyRate: 220,
                        experience: 8,
                        location: 'San Francisco, CA',
                        profileImage: 'https://placehold.co/400x400/8b5cf6/ffffff?text=Lisa+C',
                        portfolio: [
                            'https://placehold.co/600x400/fefce8/a16207?text=Wedding+1',
                            'https://placehold.co/600x400/ecfccb/4d7c0f?text=Wedding+2',
                            'https://placehold.co/600x400/f0f9ff/0ea5e9?text=Event+1',
                            'https://placehold.co/600x400/fef2f2/be123c?text=Event+2'
                        ]
                    },
                    {
                        id: 'photo8',
                        name: 'Robert Brown',
                        email: 'robert@example.com',
                        password: 'password123',
                        role: 'photographer',
                        specialties: ['commercial', 'architecture'],
                        bio: 'Commercial and architectural photographer with expertise in real estate and interior design.',
                        hourlyRate: 160,
                        experience: 11,
                        location: 'Seattle, WA',
                        profileImage: 'https://placehold.co/400x400/06b6d4/ffffff?text=Robert+B',
                        portfolio: [
                            'https://placehold.co/600x400/ecfccb/4d7c0f?text=Architecture+1',
                            'https://placehold.co/600x400/fefce8/a16207?text=Commercial+1',
                            'https://placehold.co/600x400/f0f9ff/0ea5e9?text=Architecture+2',
                            'https://placehold.co/600x400/fef2f2/be123c?text=Commercial+2'
                        ]
                    }
                ];
                
                allPhotographers = samplePhotographers;
                allUsers = [...allUsers, ...samplePhotographers];
                saveToLocalStorage();
            }
            
            // Add sample bookings if none exist for testing
            const existingBookings = JSON.parse(localStorage.getItem('lenslink_bookings') || '[]');
            if (existingBookings.length === 0) {
                const sampleBookings = [
                    {
                        id: 'booking_' + Date.now(),
                        photographerId: 'photo1', // Jane Doe
                        photographerName: 'Jane Doe',
                        clientId: 'client1',
                        clientName: 'Sarah Johnson',
                        clientEmail: 'sarah.johnson@example.com',
                        clientPhone: '+1-555-0104',
                        clientProfileImage: 'https://placehold.co/400x400/34d399/ffffff?text=Sarah',
                        date: '2025-08-15',
                        time: '14:00',
                        sessionType: 'Portrait Session',
                        duration: 2,
                        requirements: 'Outdoor location preferred, natural lighting',
                        totalCost: 400,
                        status: 'pending',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        id: 'booking_' + (Date.now() + 1),
                        photographerId: 'photo1', // Jane Doe
                        photographerName: 'Jane Doe',
                        clientId: 'client2',
                        clientName: 'Mark Thompson',
                        clientEmail: 'mark.thompson@example.com',
                        clientPhone: '+1-555-0105',
                        clientProfileImage: 'https://placehold.co/400x400/ef4444/ffffff?text=Mark',
                        date: '2025-08-20',
                        time: '10:00',
                        sessionType: 'Wedding Photography',
                        duration: 6,
                        requirements: 'Full wedding coverage needed',
                        totalCost: 1200,
                        status: 'confirmed',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        id: 'booking_' + (Date.now() + 2),
                        photographerId: 'photo2', // John Smith
                        photographerName: 'John Smith',
                        clientId: 'client3',
                        clientName: 'Emma Wilson',
                        clientEmail: 'emma.wilson@example.com',
                        clientPhone: '+1-555-0106',
                        clientProfileImage: 'https://placehold.co/400x400/8b5cf6/ffffff?text=Emma',
                        date: '2025-08-25',
                        time: '16:30',
                        sessionType: 'Event Photography',
                        duration: 4,
                        requirements: 'Corporate event, professional headshots needed',
                        totalCost: 600,
                        status: 'completed',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    }
                ];
                
                localStorage.setItem('lenslink_bookings', JSON.stringify(sampleBookings));
            }
        }

        // NOTE: handleLogin and handleRegister are defined earlier in the file (lines ~1485 and ~1589)
        // Removed duplicate functions that were overwriting the better implementations

        function handleLogout() {
            // Clear current user
            currentUser = null;
            localStorage.removeItem(STORAGE_KEYS.currentUser);
            
            // Clear any form data
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.reset();
                // Ensure login form is visible after logout
                loginForm.style.display = 'block';
            }
            const registerForm = document.getElementById('register-form');
            if (registerForm) {
                registerForm.reset();
                registerForm.style.display = 'none';
            }
            
            // Reset login/register tabs to login as default
            const loginTab = document.getElementById('login-tab');
            const registerTab = document.getElementById('register-tab');
            if (loginTab && registerTab) {
                loginTab.classList.add('border-orange-500', 'text-orange-500');
                loginTab.classList.remove('text-slate-500');
                registerTab.classList.remove('border-orange-500', 'text-orange-500');
                registerTab.classList.add('text-slate-500');
            }
            
            // Clear messages
            clearMessages();
            
            // Update UI
            updateUI();
            
            // Go to home page
            showPage('home');
            
            // Show success message
            setTimeout(() => {
                alert('You have been logged out successfully! You can now login again.');
            }, 100);
        }

        async function handlePhotographerProfileUpdate(e) {
            e.preventDefault();
            
            if (!currentUser || currentUser.role !== 'photographer') {
                alert('Access denied. Please login as a photographer.');
                return;
            }
            
            console.log('ð€ Starting profile update...');
            
            // Get form data
            const name = document.getElementById('edit-name').value.trim();
            const bio = document.getElementById('edit-bio').value.trim();
            const location = document.getElementById('edit-location').value.trim();
            const hourlyRate = document.getElementById('edit-hourly-rate').value;
            const experience = document.getElementById('edit-experience').value;
            const backupCount = document.getElementById('edit-backup-count')?.value || '0';
            
            // Get selected specialties
            const specialtyCheckboxes = document.querySelectorAll('.edit-specialty-checkbox:checked');
            const specialties = Array.from(specialtyCheckboxes).map(checkbox => checkbox.value);
            
            // Validation
            if (!name) {
                showEditMessage('profile-edit-error', 'Please enter your full name', 'error');
                return;
            }
            
            if (!bio) {
                showEditMessage('profile-edit-error', 'Please enter a bio', 'error');
                return;
            }
            
            if (specialties.length === 0) {
                showEditMessage('profile-edit-error', 'Please select at least one specialty', 'error');
                return;
            }
            
            // Portfolio minimum: require at least 3 portfolio photos
            const existingPortfolioCount = currentUser.portfolio ? currentUser.portfolio.length : 0;
            const newPortfolioCount = window.editPortfolioImages ? window.editPortfolioImages.length : 0;
            if (existingPortfolioCount + newPortfolioCount < 3) {
                showEditMessage('profile-edit-error', `Please add at least 3 portfolio photos (you have ${existingPortfolioCount}${newPortfolioCount > 0 ? ' + ' + newPortfolioCount + ' new' : ''}).`, 'error');
                return;
            }

            clearEditMessages();

            // Show loading
            const submitBtn = document.querySelector('#photographer-profile-form button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';
            
            try {
                // Determine profile photo (base64 if new upload, otherwise keep existing)
                const newProfilePhoto = window.newProfilePhotoData || null;

                // Build API payload
                const apiPayload = {
                    bio: bio,
                    specialties: specialties,
                    location: { city: location, address: location },
                    pricing: { hourlyRate: hourlyRate ? parseInt(hourlyRate) : (currentUser.hourlyRate || 150) },
                    experience: { years: experience ? parseInt(experience) : 0 },
                    backupCount: parseInt(backupCount) || 0
                };
                if (newProfilePhoto) {
                    apiPayload.profilePhoto = newProfilePhoto;
                }

                // Call backend API to save profile
                const token = localStorage.getItem('authToken');
                const apiRes = await fetch(`${API_BASE_URL}/photographers/profile`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(apiPayload)
                });

                const apiData = await apiRes.json();
                if (!apiData.success) {
                    throw new Error(apiData.message || 'API update failed');
                }

                // Update currentUser locally from API response
                currentUser.name = name;
                currentUser.bio = bio;
                currentUser.location = location;
                currentUser.specialties = specialties;
                currentUser.hourlyRate = apiPayload.pricing.hourlyRate;
                currentUser.experience = apiPayload.experience.years;
                currentUser.backupCount = parseInt(backupCount) || 0;
                if (newProfilePhoto) currentUser.profileImage = newProfilePhoto;
                window.newProfilePhotoData = null; // Clear after save

                // Handle new portfolio image uploads with progress tracking
                if (window.editPortfolioImages && window.editPortfolioImages.length > 0) {
                    const totalImages = window.editPortfolioImages.length;
                    let doneCount = 0;

                    // Show progress UI
                    const progressContainer = document.getElementById('upload-progress-container');
                    const progressBar = document.getElementById('upload-progress-bar');
                    const progressText = document.getElementById('upload-progress-text');
                    const progressCount = document.getElementById('upload-progress-count');
                    const progressList = document.getElementById('upload-progress-list');
                    if (progressContainer) progressContainer.classList.remove('hidden');
                    if (progressText) progressText.textContent = 'Uploading portfolio photos...';
                    if (progressCount) progressCount.textContent = `0 / ${totalImages}`;
                    if (progressBar) progressBar.style.width = '0%';
                    if (progressList) progressList.innerHTML = window.editPortfolioImages.map((img, i) =>
                        `<div id="upload-item-${i}" class="flex items-center space-x-2 text-xs">
                            <span id="upload-icon-${i}" class="text-slate-400">○</span>
                            <span class="truncate text-slate-600">${img.name}</span>
                        </div>`
                    ).join('');

                    const uploadOne = async (img, idx) => {
                        const iconEl = document.getElementById(`upload-icon-${idx}`);
                        try {
                            const res = await fetch(`${API_BASE_URL}/photographers/portfolio`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                },
                                body: JSON.stringify({
                                    title: img.name || 'Portfolio Image',
                                    imageUrl: img.compressedData || img.data,
                                    category: 'other',
                                    description: ''
                                })
                            });
                            const data = await res.json();
                            if (!res.ok || !data.success) throw new Error(data.message || 'Upload failed');
                            if (iconEl) iconEl.textContent = '✓';
                            if (iconEl) iconEl.className = 'text-green-600 font-bold';
                        } catch(pe) {
                            console.warn(`Portfolio image upload failed (${img.name}):`, pe.message);
                            if (iconEl) iconEl.textContent = '✗';
                            if (iconEl) iconEl.className = 'text-red-500 font-bold';
                        } finally {
                            doneCount++;
                            const pct = Math.round((doneCount / totalImages) * 100);
                            if (progressBar) progressBar.style.width = pct + '%';
                            if (progressCount) progressCount.textContent = `${doneCount} / ${totalImages}`;
                        }
                    };

                    // Upload all in parallel
                    await Promise.allSettled(window.editPortfolioImages.map((img, idx) => uploadOne(img, idx)));

                    // Reload portfolio from API to get real saved data
                    try {
                        const refreshRes = await fetch(`${API_BASE_URL}/photographers/profile`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        const refreshData = await refreshRes.json();
                        if (refreshData.success && refreshData.photographer) {
                            currentUser.portfolio = refreshData.photographer.portfolio || [];
                        }
                    } catch(re) { console.warn('Could not refresh portfolio from API:', re.message); }

                    // Hide progress after 2 seconds
                    setTimeout(() => {
                        if (progressContainer) progressContainer.classList.add('hidden');
                    }, 2000);
                    if (progressText) progressText.textContent = 'Upload complete!';
                }

                localStorage.setItem(STORAGE_KEYS.currentUser, JSON.stringify(currentUser));

                console.log('â“ Profile updated via API');
                showEditMessage('profile-edit-success', 'Profile saved successfully!', 'success');

                updateUI();
                setTimeout(() => { showPage('photographer-dashboard-page'); }, 1200);
                
            } catch (error) {
                console.error(' Profile update failed:', error);
                showEditMessage('profile-edit-error', 'Failed to update profile. Please try again.', 'error');
            } finally {
                // Restore button
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }
        
        // Initialize edit profile page with current user data
        function initializeEditProfile() {
            console.log('🎨 initializeEditProfile called');
            
            if (!currentUser || currentUser.role !== 'photographer') {
                console.log(' Access denied - not a photographer or not logged in');
                alert('Access denied. Please login as a photographer first.');
                showPage('home');
                return;
            }
            
            console.log('🎨 Initializing edit profile page for:', currentUser.name);
            
            // Populate form fields with current data with error handling
            try {
                const nameField = document.getElementById('edit-name');
                const bioField = document.getElementById('edit-bio');
                const locationField = document.getElementById('edit-location');
                const rateField = document.getElementById('edit-hourly-rate');
                const experienceField = document.getElementById('edit-experience');
                
                if (nameField) {
                    nameField.value = currentUser.name || '';
                    console.log('â“ Set name field');
                } else {
                    console.log(' Name field not found');
                }
                
                if (bioField) {
                    bioField.value = currentUser.bio || '';
                    console.log('â“ Set bio field');
                } else {
                    console.log(' Bio field not found');
                }
                
                if (locationField) {
                    locationField.value = currentUser.location || '';
                    console.log('â“ Set location field');
                } else {
                    console.log(' Location field not found');
                }
                
                if (rateField) {
                    rateField.value = currentUser.hourlyRate || '';
                    console.log('â“ Set rate field');
                } else {
                    console.log(' Rate field not found');
                }
                
                if (experienceField) {
                    experienceField.value = currentUser.experience || '';
                    console.log('â“ Set experience field');
                } else {
                    console.log(' Experience field not found');
                }
            } catch (error) {
                console.error(' Error setting form fields:', error);
            }
            
            // Set current profile image
            const currentProfileImage = document.getElementById('current-profile-image');
            if (currentProfileImage) {
                currentProfileImage.innerHTML = `
                    <img src="${currentUser.profileImage || 'https://placehold.co/80x80/94a3b8/ffffff?text=' + currentUser.name.charAt(0)}" 
                         alt="Current profile" 
                         class="w-full h-full object-cover">
                `;
            }
            
            // Set selected specialties
            const specialtyCheckboxes = document.querySelectorAll('.edit-specialty-checkbox');
            if (specialtyCheckboxes.length > 0 && currentUser.specialties) {
                specialtyCheckboxes.forEach(checkbox => {
                    checkbox.checked = currentUser.specialties.includes(checkbox.value);
                });
            }
            
            // Display current portfolio images
            displayCurrentPortfolioImages();
            
            // Clear any previous image selections
            document.getElementById('edit-profile-photo').value = '';
            document.getElementById('edit-portfolio-images').value = '';
            document.getElementById('edit-profile-image-preview').innerHTML = '';
            document.getElementById('edit-portfolio-preview').innerHTML = '';
            
            // Reset portfolio images array for editing
            window.editPortfolioImages = [];
            
            clearEditMessages();
        }
        
        // Manual initialization as backup
        function manuallyInitializeEditProfile() {
            console.log('ð€§ Manual edit profile initialization');
            
            if (!currentUser || currentUser.role !== 'photographer') {
                console.log(' Manual init failed - not a photographer');
                return;
            }
            
            // Basic form population with error handling
            setTimeout(() => {
                const fields = {
                    'edit-name': currentUser.name || '',
                    'edit-bio': currentUser.bio || '',
                    'edit-location': currentUser.location || '',
                    'edit-hourly-rate': currentUser.hourlyRate || '',
                    'edit-experience': currentUser.experience || '',
                    'edit-backup-count': currentUser.backupCount || ''
                };
                
                Object.keys(fields).forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.value = fields[id];
                        console.log(`â“ Set ${id} to:`, fields[id]);
                    } else {
                        console.log(` Field ${id} not found`);
                    }
                });
                
                // Set profile image
                const profileImg = document.getElementById('current-profile-image');
                if (profileImg) {
                    profileImg.innerHTML = `
                        <img src="${currentUser.profileImage || 'https://placehold.co/80x80/94a3b8/ffffff?text=' + currentUser.name.charAt(0)}" 
                             alt="Current profile" 
                             class="w-full h-full object-cover">
                    `;
                }
                
                // Set specialties
                const specialtyCheckboxes = document.querySelectorAll('.edit-specialty-checkbox');
                if (specialtyCheckboxes.length > 0 && currentUser.specialties) {
                    specialtyCheckboxes.forEach(checkbox => {
                        checkbox.checked = currentUser.specialties.includes(checkbox.value);
                    });
                }
                
                console.log('â“ Manual initialization complete');
            }, 200);
        }
        
        // Display current portfolio images with delete functionality
        function displayCurrentPortfolioImages() {
            const container = document.getElementById('current-portfolio-images');
            if (!container) return;
            
            if (!currentUser.portfolio || currentUser.portfolio.length === 0) {
                container.innerHTML = '<p class="col-span-full text-center text-slate-500 text-sm">No portfolio images yet</p>';
                return;
            }
            
            container.innerHTML = currentUser.portfolio.map((portfolioItem, index) => {
                const imageData = portfolioItem.imageUrl || portfolioItem.data || (typeof portfolioItem === 'string' ? portfolioItem : '');
                const imageName = portfolioItem.title || portfolioItem.name || `Portfolio Image ${index + 1}`;
                return `
                    <div class="relative group">
                        <img src="${imageData}" 
                             alt="${imageName}" 
                             class="w-full h-20 object-cover rounded-lg border-2 border-slate-200">
                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 transition-opacity rounded-lg flex items-center justify-center">
                            <button onclick="removeCurrentPortfolioImage(${index})" 
                                    class="opacity-0 group-hover:opacity-100 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600 transition-all">
                                ×
                            </button>
                        </div>
                        <p class="text-xs text-slate-500 mt-1 truncate">${imageName}</p>
                    </div>
                `;
            }).join('');
        }
        
        // Remove current portfolio image
        window.removeCurrentPortfolioImage = function(index) {
            if (!currentUser.portfolio || index >= currentUser.portfolio.length) return;
            
            if (confirm('Are you sure you want to remove this image from your portfolio?')) {
                currentUser.portfolio.splice(index, 1);
                
                // Update in storage arrays
                const userIndex = allUsers.findIndex(u => u.id === currentUser.id);
                if (userIndex !== -1) {
                    allUsers[userIndex].portfolio = currentUser.portfolio;
                }
                
                const photographerIndex = allPhotographers.findIndex(p => p.id === currentUser.id);
                if (photographerIndex !== -1) {
                    allPhotographers[photographerIndex].portfolio = currentUser.portfolio;
                }
                
                // Save to localStorage
                saveToLocalStorage();
                localStorage.setItem(STORAGE_KEYS.currentUser, JSON.stringify(currentUser));
                
                // Refresh display
                displayCurrentPortfolioImages();
                
                console.log('â“ Removed portfolio image at index', index);
            }
        };
        
        // Helper functions for edit profile messages
        function showEditMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.className = `text-sm text-center ${type === 'error' ? 'text-red-600' : 'text-green-600'}`;
                element.classList.remove('hidden');
            }
        }
        
        function clearEditMessages() {
            const messageElements = ['profile-edit-error', 'profile-edit-success'];
            messageElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.classList.add('hidden');
                }
            });
        }
        
        // Profile image preview for edit page
        function previewEditProfileImage(input) {
            const file = input.files[0];
            const previewContainer = document.getElementById('edit-profile-image-preview');
            
            if (!file) {
                if (previewContainer) previewContainer.innerHTML = '';
                window.newProfilePhotoData = null;
                return;
            }
            
            // Validate file
            const validation = validateImageFile(file);
            if (!validation.valid) {
                alert(validation.error);
                input.value = '';
                if (previewContainer) previewContainer.innerHTML = '';
                return;
            }
            
            // Show loading indicator
            if (previewContainer) {
                previewContainer.innerHTML = `
                    <div class="text-center py-4">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-orange-500 mx-auto"></div>
                        <p class="text-sm text-slate-600 mt-2">Processing new profile image...</p>
                    </div>
                `;
            }
            
            // Compress and preview image (800x800 for profile)
            compressImage(file, 800, 800, 0.85).then(compressedDataUrl => {
                if (previewContainer) {
                    const originalSize = (file.size / 1024).toFixed(1);
                    const compressedSize = (compressedDataUrl.length * 0.75 / 1024).toFixed(1);
                    
                    previewContainer.innerHTML = `
                        <div class="flex items-center space-x-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                            <img src="${compressedDataUrl}" 
                                 alt="New profile preview" 
                                 class="w-16 h-16 rounded-full object-cover border-2 border-green-300">
                            <div>
                                <p class="text-sm text-green-700 font-medium">â“ New profile image ready</p>
                                <p class="text-xs text-green-600">Optimized: ${originalSize}KB â€  ${compressedSize}KB</p>
                            </div>
                        </div>
                    `;
                }
                
                // Store in module-level variable (reliable across form submission)
                window.newProfilePhotoData = compressedDataUrl;
            }).catch(error => {
                console.error('Profile image processing failed:', error);
                if (previewContainer) {
                    previewContainer.innerHTML = `
                        <div class="text-center py-4">
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                                <p class="text-sm text-yellow-700">ï Image processing failed</p>
                                <p class="text-xs text-yellow-600 mt-1">Please try a different image</p>
                            </div>
                        </div>
                    `;
                }
                window.newProfilePhotoData = null;
            });
        }
        
        // Portfolio images preview for edit page
        window.editPortfolioImages = [];
        
        function previewEditPortfolioImages(input) {
            const files = Array.from(input.files);
            const previewContainer = document.getElementById('edit-portfolio-preview');
            
            if (!files.length) {
                if (previewContainer) previewContainer.innerHTML = '';
                window.editPortfolioImages = [];
                return;
            }
            
            // Limit total portfolio images to 20
            const currentCount = currentUser.portfolio ? currentUser.portfolio.length : 0;
            const newCount = files.length;
            const totalCount = currentCount + newCount;
            
            if (totalCount > 20) {
                alert(`You can have maximum 20 portfolio images total. You currently have ${currentCount} images. Please select maximum ${20 - currentCount} new images.`);
                input.value = '';
                return;
            }
            
            // Validate all files
            for (let file of files) {
                const validation = validateImageFile(file);
                if (!validation.valid) {
                    alert(`Error with "${file.name}": ${validation.error}`);
                    input.value = '';
                    if (previewContainer) previewContainer.innerHTML = '';
                    return;
                }
            }
            
            // Show loading indicator
            if (previewContainer) {
                previewContainer.innerHTML = `
                    <div class="col-span-full text-center py-4">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-orange-500 mx-auto"></div>
                        <p class="text-sm text-slate-600 mt-2">Processing ${files.length} new portfolio images...</p>
                    </div>
                `;
            }
            
            // Process all images
            window.editPortfolioImages = [];
            let processedCount = 0;
            
            files.forEach((file, index) => {
                compressImage(file, 1200, 1200, 0.85).then(compressedDataUrl => {
                    window.editPortfolioImages.push({
                        name: file.name,
                        originalSize: file.size,
                        compressedData: compressedDataUrl,
                        index: index
                    });
                    
                    processedCount++;
                    
                    // Update preview once all images are processed
                    if (processedCount === files.length) {
                        updateEditPortfolioPreview();
                    }
                }).catch(error => {
                    console.error(`Failed to process ${file.name}:`, error);
                    processedCount++;
                    
                    if (processedCount === files.length) {
                        updateEditPortfolioPreview();
                    }
                });
            });
        }
        
        function updateEditPortfolioPreview() {
            const previewContainer = document.getElementById('edit-portfolio-preview');
            if (!previewContainer) return;
            
            if (window.editPortfolioImages.length === 0) {
                previewContainer.innerHTML = '<p class="col-span-full text-center text-slate-500">No new images to add</p>';
                return;
            }
            
            previewContainer.innerHTML = `
                <div class="col-span-full mb-2 p-2 bg-blue-50 border border-blue-200 rounded-lg">
                    <p class="text-sm text-blue-700 font-medium">
                        â“ ${window.editPortfolioImages.length} new images ready to add
                    </p>
                </div>
                ${window.editPortfolioImages.map((img, index) => `
                    <div class="relative group">
                        <img src="${img.compressedData}" 
                             alt="New portfolio ${index + 1}" 
                             class="w-full h-20 object-cover rounded-lg border-2 border-blue-200">
                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-opacity rounded-lg flex items-center justify-center">
                            <button onclick="removeEditPortfolioImage(${index})" 
                                    class="opacity-0 group-hover:opacity-100 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600 transition-all">
                                ×
                            </button>
                        </div>
                        <p class="text-xs text-slate-500 mt-1 truncate">${img.name}</p>
                    </div>
                `).join('')}
            `;
        }
        
        function removeEditPortfolioImage(index) {
            window.editPortfolioImages.splice(index, 1);
            updateEditPortfolioPreview();
        }
        
        // Make functions globally accessible for edit profile
        window.previewEditProfileImage = previewEditProfileImage;
        window.previewEditPortfolioImages = previewEditPortfolioImages;
        window.removeEditPortfolioImage = removeEditPortfolioImage;
        
        // Debug test function for edit profile - Make globally accessible
        window.testEditProfile = function() {
            console.log('ð€§ TEST: Edit profile button clicked');
            console.log('ð€§ TEST: Current user:', currentUser);
            console.log('ð€§ TEST: User role:', currentUser?.role);
            
            if (!currentUser) {
                alert(' TEST: No user logged in!');
                return;
            }
            
            if (currentUser.role !== 'photographer') {
                alert(' TEST: User is not a photographer! Role: ' + currentUser.role);
                return;
            }
            
            console.log('ð€§ TEST: Trying to show edit profile page...');
            
            // Hide all pages
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => {
                page.classList.remove('active');
                console.log('ð€§ TEST: Hiding page:', page.id);
            });
            
            // Show edit profile page
            const editPage = document.getElementById('photographer-profile-edit');
            if (editPage) {
                editPage.classList.add('active');
                console.log('â“ TEST: Edit profile page found and activated');
                
                // Try to populate one field as test
                setTimeout(() => {
                    const nameField = document.getElementById('edit-name');
                    if (nameField) {
                        nameField.value = currentUser.name || 'Test Name';
                        console.log('â“ TEST: Name field populated');
                        alert('â“ TEST SUCCESS: Edit profile page is working! Check the form.');
                    } else {
                        console.log(' TEST: Name field not found');
                        alert(' TEST: Page loaded but form fields not found');
                    }
                }, 100);
            } else {
                console.log(' TEST: Edit profile page not found');
                alert(' TEST: Edit profile page element not found in DOM');
            }
        }

        // --- UI Functions ---
        function updateUI() {
            if (currentUser) {
                // Show user menu, hide auth buttons
                if (authButtons) authButtons.classList.add('hidden');
                if (userMenu) userMenu.classList.remove('hidden');
                
                // Update user info
                if (userWelcome) userWelcome.textContent = `Welcome, ${currentUser.name}`;
                if (userName) userName.textContent = currentUser.name;
                if (userAvatar) {
                    const initial = encodeURIComponent((currentUser.name || 'U').charAt(0).toUpperCase());
                    const hasPhoto = currentUser.profileImage && !currentUser.profileImage.includes('default') && !currentUser.profileImage.includes('placehold.co');
                    userAvatar.src = hasPhoto ? currentUser.profileImage : `https://placehold.co/32x32/${currentUser.role === 'photographer' ? 'a78bfa/ffffff' : 'fb923c/ffffff'}?text=${initial}`;
                    userAvatar.onerror = function() { this.src = 'https://placehold.co/32x32/fb923c/ffffff?text=' + initial; };
                }
                
                // Update navigation based on role
                updateNavigationForRole();
                
                // Show photographer menu items if user is a photographer
                if (currentUser.role === 'photographer') {
                    if (photographerMenu) photographerMenu.classList.remove('hidden');
                    const findPhotographersLink = document.getElementById('find-photographers-link');
                    if (findPhotographersLink) findPhotographersLink.classList.add('hidden');
                } else {
                    if (photographerMenu) photographerMenu.classList.add('hidden');
                    const findPhotographersLink = document.getElementById('find-photographers-link');
                    if (findPhotographersLink) findPhotographersLink.classList.remove('hidden');
                }
            } else {
                // Show auth buttons, hide user menu
                if (authButtons) authButtons.classList.remove('hidden');
                if (userMenu) userMenu.classList.add('hidden');
                if (photographerMenu) photographerMenu.classList.add('hidden');
                // Reset navigation to default
                resetNavigation();
            }
        }

        function updateNavigationForRole() {
            const navLinks = document.querySelectorAll('.nav-link');
            const photographersLink = document.querySelector('.nav-link[data-page="photographers"]');
            const myBookingsLink = document.getElementById('my-bookings');
            
            if (currentUser && currentUser.role === 'client') {
                // For clients, hide "Find a Photographer" and hide "My Bookings" completely
                if (photographersLink) {
                    photographersLink.style.display = 'none';
                }
                if (myBookingsLink) {
                    myBookingsLink.style.display = 'none';
                }
            } else if (currentUser && currentUser.role === 'photographer') {
                // For photographers, keep navigation normal but change "My Bookings" to "My Bookings"
                if (photographersLink) {
                    photographersLink.style.display = 'block';
                }
                if (myBookingsLink) {
                    myBookingsLink.style.display = 'block';
                    myBookingsLink.textContent = 'My Bookings';
                }
            }
        }

        function resetNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            const photographersLink = document.querySelector('.nav-link[data-page="photographers"]');
            const myBookingsLink = document.getElementById('my-bookings');
            
            // Reset to default navigation
            if (photographersLink) {
                photographersLink.style.display = 'block';
            }
            if (myBookingsLink) {
                myBookingsLink.textContent = 'My Bookings';
            }
        }

        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            if (element) {
                // If trying to show success but there's already an error visible, don't show success
                if (type === 'success' && elementId.includes('register')) {
                    const errorElement = document.getElementById('register-error');
                    if (errorElement && !errorElement.classList.contains('hidden')) {
                        console.log('ï Skipping success message because error is visible');
                        return;
                    }
                }
                
                element.textContent = message;
                let colorClass = 'text-green-600'; // default for success
                if (type === 'error' || type === 'warning') {
                    colorClass = 'text-red-600';
                } else if (type === 'info') {
                    colorClass = 'text-blue-600';
                }
                element.className = `text-sm text-center ${colorClass}`;
                element.classList.remove('hidden');
                
                console.log(`ð€oeÂ¢ Message shown (${type}):`, message);
            }
        }

        function clearMessages() {
            const messageElements = ['login-error', 'login-success', 'register-error', 'register-success'];
            messageElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.classList.add('hidden');
                }
            });
        }

        function showLoading(formId, isLoading) {
            const form = document.getElementById(formId);
            const submitButton = form.querySelector('button[type="submit"]');
            
            if (isLoading) {
                submitButton.disabled = true;
                submitButton.textContent = 'Loading...';
            } else {
                submitButton.disabled = false;
                submitButton.textContent = formId === 'login-form' ? 'Log In' : 'Create Account';
            }
        }

        // --- Initialization ---
        async function initializeApp() {
            // Load data from backend first, then fallback to localStorage
            await loadDataFromBackend();
            
            // Initialize booking form
            initializeBookingForm();
            
            // Update UI based on current user state
            if (currentUser) {
                updateUI();
            } else {
                updateUI();
            }
        }

        // Load data from backend API
        async function loadDataFromBackend() {
            try {
                console.log('ð€ Loading data from backend...');
                
                // Try to fetch photographers from backend
                const response = await fetch('/api/photographers');
                if (response.ok) {
                    const data = await response.json();
                    if (data.photographers && data.photographers.length > 0) {
                        allPhotographers = data.photographers;
                        console.log('â“ Loaded', allPhotographers.length, 'photographers from backend');
                        
                        // Save to localStorage as backup
                        localStorage.setItem(STORAGE_KEYS.photographers, JSON.stringify(allPhotographers));
                        
                        // Display photographers
                        displayPhotographersInBookingPage(allPhotographers);
                        return;
                    } else {
                        // Backend has no photographers, let's populate it with sample data
                        console.log('ð€oe Backend empty, populating with sample photographers...');
                        await populateBackendWithSampleData();
                    }
                }
                
                console.log('ï No data from backend, using localStorage...');
            } catch (error) {
                console.log(' Backend error:', error.message, '- using localStorage');
            }
            
            // Fallback to localStorage
            loadFromLocalStorage();
        }

        // Populate backend with sample photographer data
        async function populateBackendWithSampleData() {
            const samplePhotographers = [
                {
                    name: "Sarah Johnson",
                    email: "sarah@lenslink.com",
                    password: "password123",
                    userType: "photographer",
                    specialties: ["Portrait", "Wedding"],
                    hourlyRate: 150,
                    experience: 5,
                    location: "New York, NY",
                    bio: "Passionate photographer specializing in weddings and portraits with a natural, candid style.",
                    profileImage: "https://images.unsplash.com/photo-1494790108755-2616b612b647?w=400&h=400&fit=crop&crop=face",
                    portfolio: []
                },
                {
                    name: "Michael Chen",
                    email: "michael@lenslink.com",
                    password: "password123",
                    userType: "photographer",
                    specialties: ["Commercial", "Fashion"],
                    hourlyRate: 200,
                    experience: 8,
                    location: "Los Angeles, CA",
                    bio: "Award-winning commercial and fashion photographer with a creative eye for detail.",
                    profileImage: "https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=400&h=400&fit=crop&crop=face",
                    portfolio: []
                },
                {
                    name: "Emily Rodriguez",
                    email: "emily@lenslink.com",
                    password: "password123",
                    userType: "photographer",
                    specialties: ["Nature", "Landscape"],
                    hourlyRate: 120,
                    experience: 6,
                    location: "Denver, CO",
                    bio: "Nature enthusiast capturing the beauty of landscapes and wildlife across the country.",
                    profileImage: "https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=400&h=400&fit=crop&crop=face",
                    portfolio: []
                }
            ];

            try {
                for (const photographer of samplePhotographers) {
                    const response = await fetch('/api/auth/register', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(photographer)
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('â“ Created photographer:', photographer.name);
                    } else {
                        console.log('ï Failed to create photographer:', photographer.name);
                    }
                }
                
                // Reload photographers after creating them
                setTimeout(() => {
                    loadDataFromBackend();
                }, 1000);
                
            } catch (error) {
                console.log(' Error populating backend:', error.message);
            }
        }

        // --- Photographers Functions (Local Storage) ---
        async function loadPhotographers() {
            displayPhotographers(allPhotographers);
        }

        function displayPhotographers(photographers) {
            const container = document.querySelector('#photographers .grid');
            if (!container) return;

            container.innerHTML = photographers.map(photographer => `
                <div class="bg-white rounded-lg shadow-md overflow-hidden transform hover:-translate-y-2 transition-transform duration-300">
                    <img src="${photographer.profileImage}" 
                         alt="Photographer ${photographer.name}" class="w-full h-48 object-cover">
                    <div class="p-6">
                        <h3 class="text-xl font-bold">${photographer.name}</h3>
                        <p class="text-slate-600 mb-2">${photographer.specialties ? photographer.specialties.join(', ') : 'Professional Photographer'}</p>
                        <p class="text-sm text-slate-500 mb-4">$${photographer.hourlyRate || 150}/hour</p>
                        <button onclick="viewPhotographerProfile('${photographer.id}')" 
                                class="w-full text-center bg-orange-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-orange-600 transition-colors">
                            View Profile & Book
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function viewPhotographerProfile(photographerId) {
            const photographer = allPhotographers.find(p => p.id === photographerId);
            if (photographer) {
                window.selectedPhotographer = photographer;
                showPage('profile');
                displayPhotographerProfile(photographer);
            }
        }

        function displayPhotographerProfile(photographer) {
            const profilePage = document.getElementById('profile');
            if (!profilePage) return;

            profilePage.innerHTML = `
                <div class="bg-white p-8 rounded-lg shadow-lg">
                    <div class="flex flex-col md:flex-row gap-8">
                        <div class="md:w-1/3 text-center md:text-left">
                            <img src="${photographer.profileImage}" 
                                 alt="Photographer ${photographer.name}" class="w-48 h-48 rounded-full mx-auto md:mx-0 object-cover shadow-md">
                            <h1 class="text-3xl font-bold font-serif-display mt-4">${photographer.name}</h1>
                            <p class="text-slate-600 text-lg">${photographer.specialties ? photographer.specialties.join(', ') : 'Professional Photographer'}</p>
                            <p class="mt-4 text-slate-700">${photographer.bio || 'Capturing beautiful moments with passion and creativity.'}</p>
                            <div class="mt-4">
                                <p class="text-lg font-semibold">$${photographer.hourlyRate || 150}/hour</p>
                                <p class="text-sm text-slate-600">${photographer.experience || 5}+ years experience</p>
                                <p class="text-sm text-slate-600">${photographer.location || 'Available for travel'}</p>
                            </div>
                        </div>
                        <div class="md:w-2/3">
                            <h2 class="text-2xl font-bold mb-4 border-b pb-2">Book Photography Session</h2>
                            ${currentUser ? `
                                <div class="grid md:grid-cols-2 gap-6">
                                    <!-- Booking Calendar -->
                                    <div class="bg-slate-50 p-6 rounded-lg">
                                        <h3 class="text-lg font-semibold mb-4">Select Date & Time</h3>
                                        <div id="booking-calendar" class="mb-4"></div>
                                        <button onclick="openBookingModal('${photographer.id}')" 
                                                class="w-full bg-orange-500 text-white px-6 py-3 rounded-md hover:bg-orange-600 font-semibold">
                                            Book Photography Session
                                        </button>
                                    </div>
                                    
                                    <!-- Contact Details -->
                                    <div class="bg-white border-2 border-slate-200 p-6 rounded-lg">
                                        <h3 class="text-lg font-semibold mb-4">Contact Information</h3>
                                        <div class="space-y-3">
                                            <div class="flex items-center gap-3">
                                                <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 7.89a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                                </svg>
                                                <span class="text-slate-700">${photographer.email}</span>
                                            </div>
                                            <div class="flex items-center gap-3">
                                                <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                                </svg>
                                                <span class="text-slate-700">${photographer.phone || '+1 (555) 123-4567'}</span>
                                            </div>
                                            <div class="flex items-center gap-3">
                                                <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                </svg>
                                                <span class="text-slate-700">${photographer.location || 'Available for travel'}</span>
                                            </div>
                                        </div>
                                        <div class="mt-4 p-3 bg-orange-50 rounded-lg">
                                            <p class="text-sm text-orange-800">
                                                <strong>Booking Rate:</strong> $${photographer.hourlyRate || 150}/hour
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            ` : `
                                <div class="bg-slate-50 p-6 rounded-lg">
                                    <p class="text-slate-600 mb-4">Please log in to book a session with ${photographer.name}.</p>
                                    <button onclick="showPage('login')" 
                                            class="bg-orange-500 text-white px-6 py-3 rounded-md hover:bg-orange-600">
                                        Log In to Book
                                    </button>
                                </div>
                            `}
                        </div>
                    </div>
                    
                    <div class="mt-12">
                        <h2 class="text-2xl font-bold mb-4 border-b pb-2">Portfolio</h2>
                        ${photographer.portfolio && photographer.portfolio.length > 0 ? `
                            <div class="mb-4 flex items-center justify-between">
                                <p class="text-slate-600">${photographer.portfolio.length} portfolio images</p>
                                <button onclick="viewPhotographerPortfolioPDF('${photographer.id}')" 
                                        class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 text-sm">
                                    ð€oe View Portfolio PDF
                                </button>
                            </div>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                ${photographer.portfolio.map((item, index) => `
                                    <div class="relative group">
                                        <img src="${item.imageUrl || item.data || (typeof item === 'string' ? item : '')}" 
                                             class="rounded-lg object-cover w-full h-32 cursor-pointer hover:opacity-80 transition-opacity" 
                                             alt="Portfolio image ${index + 1}"
                                             onclick="openPortfolioModal('${photographer.id}', ${index})">
                                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-opacity rounded-lg flex items-center justify-center">
                                            <span class="opacity-0 group-hover:opacity-100 text-white text-sm">View Larger</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div class="text-center py-8 bg-slate-50 rounded-lg">
                                <p class="text-slate-500 mb-4">Portfolio images coming soon</p>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 opacity-50">
                                    <img src="https://placehold.co/600x400/fefce8/a16207?text=Sample+1" class="rounded-lg object-cover w-full h-32" alt="Sample portfolio 1">
                                    <img src="https://placehold.co/600x400/ecfccb/4d7c0f?text=Sample+2" class="rounded-lg object-cover w-full h-32" alt="Sample portfolio 2">
                                    <img src="https://placehold.co/600x400/f0f9ff/0ea5e9?text=Sample+3" class="rounded-lg object-cover w-full h-32" alt="Sample portfolio 3">
                                    <img src="https://placehold.co/600x400/fef2f2/be123c?text=Sample+4" class="rounded-lg object-cover w-full h-32" alt="Sample portfolio 4">
                                </div>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        // Booking Modal Functions
        function openBookingModal(photographerId) {
            const modal = document.getElementById('booking-modal');
            
            // Clear previous booking data to prevent data persistence
            resetBookingForm();
            
            // Store photographer ID for booking
            window.currentBookingPhotographer = photographerId;
            
            modal.classList.remove('hidden');
            
            // Start with simple view (table format)
            showBookingStep('simple');
            
            // Initialize simple booking form
            initializeSimpleBookingForm();
            
            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            const simpleDateInput = document.getElementById('simple-date');
            if (simpleDateInput) {
                simpleDateInput.min = today;
                simpleDateInput.value = today;
            }
        }

        function resetBookingForm() {
            // Clear step form inputs
            const selectedDateInput = document.getElementById('selected-date');
            const selectedTimeInput = document.getElementById('selected-time');
            const sessionTypeSelect = document.getElementById('session-type');
            const requirementsTextarea = document.getElementById('special-requirements');
            
            if (selectedDateInput) selectedDateInput.value = '';
            if (selectedTimeInput) selectedTimeInput.value = '';
            if (sessionTypeSelect) sessionTypeSelect.selectedIndex = 0;
            if (requirementsTextarea) requirementsTextarea.value = '';
            
            // Clear simple form inputs
            const simpleDateInput = document.getElementById('simple-date');
            const simpleTimeSelect = document.getElementById('simple-time');
            const simpleSessionTypeSelect = document.getElementById('simple-session-type');
            const simpleRequirementsTextarea = document.getElementById('simple-requirements');
            
            if (simpleDateInput) simpleDateInput.value = '';
            if (simpleTimeSelect) simpleTimeSelect.selectedIndex = 0;
            if (simpleSessionTypeSelect) simpleSessionTypeSelect.selectedIndex = 0;
            if (simpleRequirementsTextarea) simpleRequirementsTextarea.value = '';
            const simpleLocationInput = document.getElementById('simple-location');
            if (simpleLocationInput) simpleLocationInput.value = '';
            
            // Reset time slot selections
            document.querySelectorAll('.time-slot-btn').forEach(btn => {
                btn.classList.remove('selected', 'bg-green-500', 'text-white', 'border-green-500');
                btn.classList.add('bg-white', 'border-green-200', 'text-green-800');
            });

            // Reset button states
            const continueBtns = ['continue-to-time-btn', 'continue-to-details-btn'];
            continueBtns.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) btn.disabled = true;
            });
        }

        function showBookingStep(stepNumber) {
            // Hide all steps
            document.querySelectorAll('.booking-step').forEach(step => {
                step.classList.remove('active');
                step.classList.add('hidden');
            });
            
            // Show current step
            if (stepNumber === 'simple') {
                const simpleView = document.getElementById('booking-simple-view');
                if (simpleView) {
                    simpleView.classList.remove('hidden');
                    simpleView.classList.add('active');
                }
                // Hide step indicators for simple view
                document.querySelectorAll('[id*="step-"][id*="-indicator"]').forEach(indicator => {
                    indicator.style.display = 'none';
                });
            } else {
                const currentStep = document.getElementById(`booking-step-${stepNumber}`);
                if (currentStep) {
                    currentStep.classList.remove('hidden');
                    currentStep.classList.add('active');
                }
                // Show step indicators for step view
                document.querySelectorAll('[id*="step-"][id*="-indicator"]').forEach(indicator => {
                    indicator.style.display = 'flex';
                });
                // Update step indicators
                updateStepIndicators(stepNumber);
            }
        }

        function updateStepIndicators(currentStep) {
            for (let i = 1; i <= 3; i++) {
                const indicator = document.getElementById(`step-${i}-indicator`);
                if (indicator) {
                    if (i === currentStep) {
                        indicator.classList.remove('opacity-50');
                        const circle = indicator.querySelector('div');
                        circle.classList.remove('bg-slate-300', 'text-slate-600');
                        circle.classList.add('bg-white', 'text-blue-600');
                    } else if (i < currentStep) {
                        indicator.classList.remove('opacity-50');
                        const circle = indicator.querySelector('div');
                        circle.classList.remove('bg-slate-300', 'text-slate-600', 'bg-white', 'text-blue-600');
                        circle.classList.add('bg-green-500', 'text-white');
                        circle.innerHTML = 'â“';
                    } else {
                        indicator.classList.add('opacity-50');
                        const circle = indicator.querySelector('div');
                        circle.classList.remove('bg-white', 'text-blue-600', 'bg-green-500', 'text-white');
                        circle.classList.add('bg-slate-300', 'text-slate-600');
                        circle.innerHTML = i.toString();
                    }
                }
            }
        }

        function initializeStepNavigation() {
            // Continue to time button
            const continueToTimeBtn = document.getElementById('continue-to-time');
            if (continueToTimeBtn) {
                continueToTimeBtn.addEventListener('click', () => {
                    const selectedDate = document.getElementById('selected-date').value;
                    if (selectedDate) {
                        showBookingStep(2);
                        initializeTimeSelection();
                    }
                });
            }

            // Back to date button
            const backToDateBtn = document.getElementById('back-to-date');
            if (backToDateBtn) {
                backToDateBtn.addEventListener('click', () => {
                    showBookingStep(1);
                });
            }

            // Continue to details button
            const continueToDetailsBtn = document.getElementById('continue-to-details');
            if (continueToDetailsBtn) {
                continueToDetailsBtn.addEventListener('click', () => {
                    const selectedTime = document.getElementById('selected-time').value;
                    if (selectedTime) {
                        showBookingStep(3);
                    }
                });
            }

            // Back to time button in step 3
            const backToTimeBtn = document.getElementById('back-to-time');
            if (backToTimeBtn) {
                backToTimeBtn.addEventListener('click', () => {
                    showBookingStep(2);
                });
            }
        }

        // Make globally accessible
        window.closeBookingModal = function() {
            const modal = document.getElementById('booking-modal');
            modal.classList.add('hidden');
            
            // Reset to step 1 for next booking
            showBookingStep(1);
            resetBookingForm();
        }

        // Make openBookingModal globally accessible
        window.openBookingModal = openBookingModal;

        // Global navigation functions for buttons
        window.switchToSimpleView = function() {
            showBookingStep('simple');
        }

        window.switchToStepView = function() {
            showBookingStep(1);
            initializeEnhancedBookingCalendar();
        }

        window.continueToTime = function() {
            const selectedDate = document.getElementById('selected-date').value;
            if (selectedDate) {
                showBookingStep(2);
                initializeTimeSelection();
            } else {
                alert('Please select a date first.');
            }
        }

        window.backToDate = function() {
            showBookingStep(1);
        }

        window.continueToDetails = function() {
            const selectedTime = document.getElementById('selected-time').value;
            if (selectedTime) {
                showBookingStep(3);
            } else {
                alert('Please select a time first.');
            }
        }

        window.backToTime = function() {
            showBookingStep(2);
        }

        // Map session type to API eventType
        function toEventType(sessionType) {
            const map = { portrait:'portrait', wedding:'wedding', event:'event', commercial:'commercial',
                family:'family', fashion:'fashion', graduation:'graduation', birthday:'birthday',
                nature:'other', sports:'other' };
            return map[sessionType] || 'other';
        }

        // Compute end time (start + 2 hours)
        function addHours(timeStr, hours) {
            const [h, m] = timeStr.split(':').map(Number);
            const totalMins = h * 60 + (m || 0) + hours * 60;
            const endH = Math.floor(totalMins / 60) % 24;
            const endM = totalMins % 60;
            return `${String(endH).padStart(2,'0')}:${String(endM).padStart(2,'0')}`;
        }

        // Initialize simple booking form
        function initializeSimpleBookingForm() {
            const simpleBookingForm = document.getElementById('simple-booking-form');
            if (!simpleBookingForm) return;
            // Remove old listener to prevent duplicates
            const newForm = simpleBookingForm.cloneNode(true);
            simpleBookingForm.parentNode.replaceChild(newForm, simpleBookingForm);

            newForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                if (!currentUser) {
                    alert('Please log in to book a photographer.');
                    closeBookingModal();
                    showPage('login');
                    return;
                }

                const date = document.getElementById('simple-date').value;
                const time = document.getElementById('simple-time').value;
                const sessionType = document.getElementById('simple-session-type').value;
                const location = document.getElementById('simple-location').value.trim();
                const requirements = document.getElementById('simple-requirements').value;

                if (!date || !time || !location) {
                    alert('Please fill in date, time, and shoot location.');
                    return;
                }

                const photographer = allPhotographers.find(p => p.id === window.currentBookingPhotographer
                    || p._id === window.currentBookingPhotographer);

                if (!photographer) {
                    alert('Photographer not found. Please try again.');
                    return;
                }

                const submitBtn = newForm.querySelector('[type="submit"]');
                const origText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '⏳ Booking...';

                const endTime = addHours(time, 2);
                const totalAmount = photographer.hourlyRate * 2 || 300;

                try {
                    const token = localStorage.getItem('authToken');
                    const res = await fetch(`${API_BASE_URL}/bookings`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            photographer: photographer._id,
                            bookingDate: date,
                            startTime: time.substring(0, 5),
                            endTime: endTime,
                            location: { address: location },
                            eventType: toEventType(sessionType),
                            totalAmount: totalAmount,
                            specialRequests: requirements
                        })
                    });

                    const data = await res.json();

                    if (data.success) {
                        closeBookingModal();
                        alert(`â“ Booking confirmed!\n\nPhotographer: ${photographer.name}\nDate: ${date}\nTime: ${time} â‚¬ ${endTime}\nLocation: ${location}\nTotal: $${totalAmount}\n\nA confirmation email has been sent to ${currentUser.email}.`);
                    } else {
                        alert('Booking failed: ' + (data.message || 'Unknown error'));
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = origText;
                    }
                } catch (err) {
                    console.error('Booking error:', err);
                    alert('Could not connect to server. Please try again.');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = origText;
                }
            });
        }

        function initializeEnhancedBookingCalendar() {
            const calendarDiv = document.getElementById('booking-calendar');
            if (!calendarDiv) {
                console.log('Calendar div not found, trying alternative initialization');
                // Try to find calendar in booking modal
                setTimeout(() => {
                    const modalCalendar = document.querySelector('#booking-modal #booking-calendar');
                    if (modalCalendar) {
                        initializeCalendarForDiv(modalCalendar);
                    }
                }, 100);
                return;
            }
            
            initializeCalendarForDiv(calendarDiv);
        }
        
        function initializeCalendarForDiv(calendarDiv) {
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            // Create calendar with month navigation for 3 years
            let selectedMonth = currentMonth;
            let selectedYear = currentYear;
            let selectedDate = null;
            
            function renderCalendar(month, year) {
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startingDay = firstDay.getDay();
                
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'];
                
                let calendarHTML = `
                    <div class="mobile-friendly-calendar bg-white rounded-lg shadow-sm border">
                        <div class="calendar-header p-4 border-b">
                            <div class="flex justify-between items-center">
                                <button type="button" onclick="changeMonth(-1)" class="p-2 bg-slate-100 rounded-lg hover:bg-slate-200 transition-colors">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                    </svg>
                                </button>
                                <h3 class="font-semibold text-lg text-slate-800">${monthNames[month]} ${year}</h3>
                                <button type="button" onclick="changeMonth(1)" class="p-2 bg-slate-100 rounded-lg hover:bg-slate-200 transition-colors">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="p-4">
                            <div class="grid grid-cols-7 gap-1 text-center text-sm font-medium text-slate-600 mb-3">
                                <div class="p-2">Sun</div>
                                <div class="p-2">Mon</div>
                                <div class="p-2">Tue</div>
                                <div class="p-2">Wed</div>
                                <div class="p-2">Thu</div>
                                <div class="p-2">Fri</div>
                                <div class="p-2">Sat</div>
                            </div>
                            <div class="grid grid-cols-7 gap-1 text-center">
                `;
                
                // Add empty cells for days before the first day of the month
                for (let i = 0; i < startingDay; i++) {
                    calendarHTML += '<div class="p-3"></div>';
                }
                
                // Add days of the month
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    // Fix timezone issue by using local date string
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const isPast = date < new Date().setHours(0, 0, 0, 0);
                    const isToday = date.toDateString() === new Date().toDateString();
                    const isSelected = selectedDate === dateStr;
                    
                    let buttonClass = 'w-10 h-10 rounded-lg text-sm font-bold transition-all duration-300 ';
                    if (isPast) {
                        buttonClass += 'text-slate-300 cursor-not-allowed bg-slate-50';
                    } else if (isSelected) {
                        buttonClass += 'bg-gradient-to-r from-blue-500 to-indigo-500 text-white shadow-xl transform scale-110 ring-2 ring-blue-200';
                    } else if (isToday) {
                        buttonClass += 'bg-gradient-to-r from-blue-100 to-indigo-100 text-blue-800 font-bold hover:from-blue-200 hover:to-indigo-200 border-2 border-blue-300';
                    } else {
                        buttonClass += 'text-slate-700 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 hover:text-blue-600 cursor-pointer hover:scale-105';
                    }
                    
                    calendarHTML += `
                        <button type="button" 
                                onclick="selectBookingDate('${dateStr}', this)" 
                                class="${buttonClass}"
                                ${isPast ? 'disabled' : ''}>
                            ${day}
                        </button>
                    `;
                }
                
                calendarHTML += `
                            </div>
                        </div>
                        ${selectedDate ? `<div class="px-4 pb-4"><div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-lg p-3 text-sm font-semibold text-blue-800">ð€oe Selected: ${new Date(selectedDate + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div></div>` : ''}
                    </div>
                `;
                
                calendarDiv.innerHTML = calendarHTML;
            }
            
            // Make changeMonth function globally available
            window.changeMonth = function(direction) {
                selectedMonth += direction;
                if (selectedMonth > 11) {
                    selectedMonth = 0;
                    selectedYear++;
                } else if (selectedMonth < 0) {
                    selectedMonth = 11;
                    selectedYear--;
                }
                
                // Limit to 3 years from current year
                if (selectedYear > currentYear + 3) {
                    selectedYear = currentYear + 3;
                    selectedMonth = 11;
                } else if (selectedYear < currentYear) {
                    selectedYear = currentYear;
                    selectedMonth = currentMonth;
                }
                
                renderCalendar(selectedMonth, selectedYear);
            };
            
            // Update selectBookingDate function
            window.selectBookingDate = function(dateStr, buttonElement) {
                selectedDate = dateStr;
                
                // Update hidden input if it exists
                const selectedDateInput = document.getElementById('selected-date') || document.getElementById('booking-date');
                if (selectedDateInput) {
                    selectedDateInput.value = dateStr;
                }
                
                // Enable continue button
                const continueBtn = document.getElementById('continue-to-time-btn');
                if (continueBtn) {
                    continueBtn.disabled = false;
                }
                
                // Re-render calendar to update selection
                renderCalendar(selectedMonth, selectedYear);
                
                // Show success message with proper date
                const displayDate = new Date(dateStr + 'T00:00:00').toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                console.log('Date selected:', dateStr, 'Display:', displayDate);
                
                // Optional: Show a brief success indication
                if (buttonElement) {
                    const originalText = buttonElement.innerHTML;
                    buttonElement.innerHTML = 'â“';
                    setTimeout(() => {
                        renderCalendar(selectedMonth, selectedYear);
                    }, 300);
                }
            };
            
            renderCalendar(selectedMonth, selectedYear);
        }
        
        function initializeTimeSelection() {
            const timeContainer = document.getElementById('time-selection');
            if (!timeContainer) return;
            
            let timeHTML = `
                <div class="time-selection mb-4">
                    <h4 class="font-semibold mb-3">Select Time</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Time Format</label>
                            <select id="time-format" class="w-full p-2 border rounded" onchange="updateTimeOptions()">
                                <option value="12">12 Hour (AM/PM)</option>
                                <option value="24">24 Hour</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Select Time</label>
                            <select id="selected-time" class="w-full p-2 border rounded">
                            </select>
                        </div>
                    </div>
                </div>
            `;
            
            timeContainer.innerHTML = timeHTML;
            updateTimeOptions();
        }
        
        window.updateTimeOptions = function() {
            const formatSelect = document.getElementById('time-format');
            const timeSelect = document.getElementById('selected-time');
            const format = formatSelect.value;
            
            let timeOptions = '';
            
            if (format === '12') {
                // 12-hour format with AM/PM
                for (let hour = 6; hour <= 11; hour++) {
                    for (let min of ['00', '30']) {
                        timeOptions += `<option value="${hour}:${min}:00">${hour}:${min} AM</option>`;
                    }
                }
                for (let hour = 12; hour <= 12; hour++) {
                    for (let min of ['00', '30']) {
                        timeOptions += `<option value="${hour}:${min}:00">${hour}:${min} PM</option>`;
                    }
                }
                for (let hour = 1; hour <= 9; hour++) {
                    for (let min of ['00', '30']) {
                        timeOptions += `<option value="${hour + 12}:${min}:00">${hour}:${min} PM</option>`;
                    }
                }
            } else {
                // 24-hour format
                for (let hour = 6; hour <= 21; hour++) {
                    for (let min of ['00', '30']) {
                        const hourStr = hour.toString().padStart(2, '0');
                        timeOptions += `<option value="${hourStr}:${min}:00">${hourStr}:${min}</option>`;
                    }
                }
            }
            
            timeSelect.innerHTML = timeOptions;
        };

        // selectBookingDate function is now handled within initializeCalendarForDiv
        
        // Initialize time selection functionality
        function initializeTimeSelection() {
            const timeSlotButtons = document.querySelectorAll('.time-slot-btn');
            const selectedTimeInput = document.getElementById('selected-time');
            
            timeSlotButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Remove selection from all buttons
                    timeSlotButtons.forEach(btn => {
                        btn.classList.remove('bg-green-500', 'text-white', 'border-green-500', 'scale-105');
                        btn.classList.add('bg-white', 'border-green-200', 'text-green-800');
                    });
                    
                    // Add selection to clicked button
                    this.classList.remove('bg-white', 'border-green-200', 'text-green-800');
                    this.classList.add('bg-green-500', 'text-white', 'border-green-500', 'scale-105');
                    
                    // Store selected time
                    const timeValue = this.getAttribute('data-time');
                    selectedTimeInput.value = timeValue;
                    
                    // Enable continue to details button
                    const continueBtn = document.getElementById('continue-to-details-btn');
                    if (continueBtn) {
                        continueBtn.disabled = false;
                    }
                    
                    console.log('Time selected:', timeValue);
                });
            });
            
            // Handle time format change
            const timeFormatRadios = document.querySelectorAll('input[name="time-format"]');
            timeFormatRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    updateTimeDisplay(this.value);
                });
            });
        }
        
        // Update time display based on format (12/24 hour)
        function updateTimeDisplay(format) {
            const timeSlotButtons = document.querySelectorAll('.time-slot-btn');
            
            timeSlotButtons.forEach(button => {
                const time24 = button.getAttribute('data-time');
                const [hour, minute] = time24.split(':');
                const hourNum = parseInt(hour);
                
                if (format === '24') {
                    button.textContent = `${hour}:${minute}`;
                } else {
                    // Convert to 12-hour format
                    if (hourNum === 0) {
                        button.textContent = `12:${minute} AM`;
                    } else if (hourNum < 12) {
                        button.textContent = `${hourNum}:${minute} AM`;
                    } else if (hourNum === 12) {
                        button.textContent = `12:${minute} PM`;
                    } else {
                        button.textContent = `${hourNum - 12}:${minute} PM`;
                    }
                }
            });
        }

        // Handle booking form submission
        function initializeBookingForm() {
            const bookingForm = document.getElementById('booking-form');
            if (bookingForm) {
                bookingForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const date = document.getElementById('selected-date').value;
                    const time = document.getElementById('selected-time').value;
                    const sessionType = document.getElementById('session-type').value;
                    const requirements = document.getElementById('special-requirements').value;
                    
                    const photographer = allPhotographers.find(p => p.id === window.currentBookingPhotographer);
                    
                    if (photographer && currentUser && date && time) {
                        // Create booking object
                        const booking = {
                            id: 'booking_' + Date.now(),
                            photographerId: photographer.id,
                            photographerName: photographer.name,
                            photographerEmail: photographer.email,
                            clientId: currentUser.id,
                            clientName: currentUser.name,
                            clientEmail: currentUser.email,
                            clientPhone: currentUser.phone || '',
                            clientProfileImage: currentUser.profileImage,
                            date: date,
                            time: time,
                            sessionType: sessionType,
                            requirements: requirements,
                            status: 'pending',
                            createdAt: new Date().toISOString(),
                            totalCost: photographer.hourlyRate || 100 // Default rate if not specified
                        };
                        
                        // Store booking in localStorage
                        let allBookings = JSON.parse(localStorage.getItem('lenslink_bookings') || '[]');
                        allBookings.push(booking);
                        localStorage.setItem('lenslink_bookings', JSON.stringify(allBookings));
                        
                        // Show success message with booking confirmation
                        showBookingConfirmation(booking, photographer);
                        closeBookingModal();
                    } else {
                        alert('Please fill in all required fields including date and time.');
                    }
                });
            }
        }
        
        function showBookingConfirmation(booking, photographer) {
            const formatTime = (time) => {
                const [hour, minute] = time.split(':');
                const h = parseInt(hour);
                if (h === 0) return `12:${minute} AM`;
                if (h < 12) return `${h}:${minute} AM`;
                if (h === 12) return `12:${minute} PM`;
                return `${h - 12}:${minute} PM`;
            };
            
            const formatDate = (dateStr) => {
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
            };
            
            const message = `
€° Booking Completed Successfully! €°

Thank you for choosing LensLink!

Booking Details:
→→→→→→→→→→→→→→→→→→→→→→→→→→→→→→→→→→→→→→→→→→→→→→→
ð€oe¸ Photographer: ${photographer.name}
ð€oe§ Contact: ${photographer.email}
ð€oe Date: ${formatDate(booking.date)}
ð€¢ Time: ${formatTime(booking.time)}
ð€oe· Session: ${booking.sessionType}
⏱ Duration: ${booking.duration} hours
ð€™Â° Total Cost: $${booking.totalCost}
ð€oe Booking ID: ${booking.id}

${photographer.name} will contact you at ${currentUser.email} to confirm the details and discuss the session requirements.

Thank you for your booking! â“¨
            `;
            
            alert(message);
        }

        // User Profile Functions
        function displayUserProfile() {
            const profileContent = document.getElementById('user-profile-content');
            if (!profileContent) {
                console.log('Profile content element not found');
                return;
            }
            
            if (!currentUser) {
                console.log('No current user found');
                profileContent.innerHTML = '<p class="text-red-600">Please log in to view your profile.</p>';
                return;
            }
            
            console.log('Displaying profile for user:', currentUser.name);
            
            profileContent.innerHTML = `
                <div class="text-center">
                    <img src="${currentUser.profileImage || 'https://placehold.co/400x400/a78bfa/ffffff?text=' + (currentUser.name ? currentUser.name.charAt(0) : 'U')}" 
                         alt="${currentUser.name}" 
                         class="w-32 h-32 rounded-full mx-auto mb-4 object-cover shadow-lg">
                    <h2 class="text-2xl font-bold">${currentUser.name}</h2>
                    <p class="text-slate-600 capitalize">${currentUser.role}</p>
                </div>
                
                <div class="space-y-6">
                    <div>
                        <h3 class="text-lg font-semibold mb-4">Account Information</h3>
                        <div class="bg-slate-50 p-4 rounded-lg space-y-3">
                            <div class="flex justify-between">
                                <span class="text-slate-600">Name:</span>
                                <span class="font-medium">${currentUser.name}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-600">Email:</span>
                                <span class="font-medium">${currentUser.email}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-600">Phone:</span>
                                <span class="font-medium">${currentUser.phone || 'Not provided'}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-600">Account Type:</span>
                                <span class="font-medium capitalize">${currentUser.role}</span>
                            </div>
                            ${currentUser.role === 'photographer' ? `
                                <div class="flex justify-between">
                                    <span class="text-slate-600">Specialties:</span>
                                    <span class="font-medium">${currentUser.specialties ? currentUser.specialties.join(', ') : 'Not specified'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-600">Experience:</span>
                                    <span class="font-medium">${currentUser.experience || 0} years</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-600">Rate:</span>
                                    <span class="font-medium">$${currentUser.hourlyRate || 150}/hour</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-600">Location:</span>
                                    <span class="font-medium">${currentUser.location || 'Not specified'}</span>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="mt-6 flex gap-3">
                            <button onclick="editProfile()" class="flex-1 bg-orange-500 text-white py-2 px-4 rounded-md hover:bg-orange-600">
                                Edit Profile
                            </button>
                            ${currentUser.role === 'photographer' ? `
                                <button onclick="showPage('photographer-dashboard-page')" class="flex-1 bg-slate-500 text-white py-2 px-4 rounded-md hover:bg-slate-600">
                                    Go to Dashboard
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function editProfile() {
            alert('Profile editing functionality would be implemented here. This is a demo version.');
        }

        // Initialize login page to ensure forms are working
        function initializeLoginPage() {
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const loginTab = document.getElementById('login-tab');
            const registerTab = document.getElementById('register-tab');
            
            // Ensure login form is visible and register form is hidden
            if (loginForm && registerForm) {
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
            }
            
            // Ensure login tab is active
            if (loginTab && registerTab) {
                loginTab.classList.add('border-orange-500', 'text-orange-500');
                loginTab.classList.remove('text-slate-500');
                registerTab.classList.remove('border-orange-500', 'text-orange-500');
                registerTab.classList.add('text-slate-500');
            }
            
            // Clear any messages
            clearMessages();
            
            // Re-attach event listeners to ensure they work
            if (loginForm) {
                loginForm.removeEventListener('submit', handleLogin);
                loginForm.addEventListener('submit', handleLogin);
            }
            if (registerForm) {
                registerForm.removeEventListener('submit', handleRegister);
                registerForm.addEventListener('submit', handleRegister);
            }
            
            console.log('Login page initialized'); // Debug log
        }

        // Normalize API photographer to local format
        function normalizePhotographer(p) {
            const name = p.user ? p.user.name : 'Photographer';
            const initial = encodeURIComponent(name.charAt(0).toUpperCase());
            // Raw profile image might be a filename like "default-profile.jpg" (not a URL)
            const rawImg = p.profilePhoto || (p.user && p.user.profileImage) || '';
            const isValidUrl = rawImg && (rawImg.startsWith('http') || rawImg.startsWith('data:'));
            const profileImage = isValidUrl
                ? rawImg
                : `https://placehold.co/400x400/f97316/ffffff?text=${initial}`;
            return {
                id: p._id,
                _id: p._id,
                name: name,
                email: p.user ? p.user.email : '',
                profileImage: profileImage,
                bio: p.bio || '',
                specialties: p.specialties || [],
                location: p.location
                    ? [p.location.city, p.location.state].filter(Boolean).join(', ') || p.location.address || ''
                    : '',
                hourlyRate: p.pricing ? p.pricing.hourlyRate : 150,
                experience: p.experience ? (p.experience.years || p.experience.yearsOfExperience || 0) : 0,
                phone: p.user ? (p.user.phone || '') : '',
                portfolio: p.portfolio || [],
                averageRating: p.averageRating || 0,
                totalReviews: p.totalReviews || 0,
            };
        }

        // Load registered photographers from API
        async function loadRegisteredPhotographers() {
            const grid = document.getElementById('registered-photographers-grid');
            if (grid) grid.innerHTML = '<div class="col-span-full text-center py-12"><div class="text-5xl mb-3">ð€oe¸</div><p class="text-slate-500 text-lg">Loading photographers...</p></div>';
            try {
                const res = await fetch(`${API_BASE_URL}/photographers?limit=50`);
                const data = await res.json();
                if (data.success && data.photographers && data.photographers.length > 0) {
                    allPhotographers = data.photographers.map(normalizePhotographer);
                    displayRegisteredPhotographers(allPhotographers);
                } else {
                    allPhotographers = [];
                    displayRegisteredPhotographers([]);
                }
            } catch (e) {
                console.error('Failed to load photographers from API', e);
                displayRegisteredPhotographers([]);
            }
        }

        function displayRegisteredPhotographers(photographers) {
            const grid = document.getElementById('registered-photographers-grid');
            if (!grid) return;

            if (!photographers || photographers.length === 0) {
                grid.innerHTML = '<div class="text-center py-8 col-span-full"><p class="text-slate-500">No photographers found. Be the first to register as a photographer!</p></div>';
                return;
            }

            grid.innerHTML = photographers.map(photographer => {
                return `
                    <div class="bg-white rounded-lg shadow-md overflow-hidden transform hover:-translate-y-2 transition-transform duration-300">
                        <img src="${photographer.profileImage}" 
                             alt="Photographer ${photographer.name}" 
                             class="w-full h-48 object-cover">
                        <div class="p-6">
                            <h3 class="text-xl font-bold">${photographer.name}</h3>
                            <p class="text-slate-600 mb-2">${photographer.specialties ? photographer.specialties.join(', ') : 'Photography Services'}</p>
                            <p class="text-slate-500 text-sm mb-3">${photographer.location || 'Location not specified'}</p>
                            <p class="text-orange-600 font-semibold mb-4">$${photographer.hourlyRate || 150}/hour</p>
                            <button onclick="viewPhotographerProfile('${photographer.id}')" 
                                    class="w-full text-center bg-orange-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-orange-600 transition-colors">
                                View Profile & Book
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Make function globally accessible
        window.searchRegisteredPhotographers = function() {
            const searchTerm = document.getElementById('photographer-search').value.toLowerCase();
            const specialty = document.getElementById('specialty-filter').value;

            const filtered = allPhotographers.filter(photographer => {
                const nameMatch = !searchTerm || photographer.name.toLowerCase().includes(searchTerm);
                const specialtyMatch = !specialty || (photographer.specialties && photographer.specialties.includes(specialty));
                
                return nameMatch && specialtyMatch;
            });

            displayRegisteredPhotographers(filtered);
        }

        // Search photographers with filters - Make globally accessible
        window.searchPhotographers = function() {
            const searchTerm = document.getElementById('search-photographer').value.toLowerCase();
            const specialty = document.getElementById('filter-specialty').value;
            const location = document.getElementById('filter-location').value.toLowerCase();
            
            const filtered = allPhotographers.filter(photographer => {
                const nameMatch = !searchTerm || photographer.name.toLowerCase().includes(searchTerm);
                const specialtyMatch = !specialty || (photographer.specialties && photographer.specialties.includes(specialty));
                const locationMatch = !location || (photographer.location && photographer.location.toLowerCase().includes(location));
                
                return nameMatch && specialtyMatch && locationMatch;
            });

            displayPhotographersInBookingPage(filtered);
        }

        function displayPhotographersInBookingPage(photographers) {
            const container = document.getElementById('photographer-results');
            if (!container) return;

            if (photographers.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center py-8"><p class="text-slate-600">No photographers found matching your criteria.</p></div>';
                return;
            }

            container.innerHTML = photographers.map(photographer => `
                <div class="bg-white rounded-lg shadow-md overflow-hidden transform hover:-translate-y-2 transition-transform duration-300">
                    <img src="${photographer.profileImage}" 
                         alt="Photographer ${photographer.name}" class="w-full h-48 object-cover">
                    <div class="p-6">
                        <h3 class="text-xl font-bold">${photographer.name}</h3>
                        <p class="text-slate-600 mb-2">${photographer.specialties ? photographer.specialties.join(', ') : 'Professional Photographer'}</p>
                        <p class="text-sm text-slate-500 mb-2">${photographer.location || 'Available for travel'}</p>
                        <p class="text-sm font-semibold text-orange-600 mb-2">$${photographer.hourlyRate || 150}/hour</p>
                        ${photographer.portfolio && photographer.portfolio.length > 0 ? 
                            `<p class="text-xs text-green-600 mb-3">ð€oe¸ ${photographer.portfolio.length} portfolio images available</p>` : 
                            `<p class="text-xs text-slate-400 mb-3">ð€oe¸ Portfolio coming soon</p>`
                        }
                        <button onclick="viewPhotographerProfile('${photographer.id}')" 
                                class="w-full text-center bg-orange-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-orange-600 transition-colors">
                            View Profile & Book
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Load photographer dashboard
        async function loadPhotographerDashboard() {
            if (!currentUser || currentUser.role !== 'photographer') {
                console.log('User not found or not a photographer:', currentUser);
                return;
            }

            // Always refresh photographer profile from API on dashboard load
            try {
                const token = localStorage.getItem('authToken');
                const res = await fetch(`${API_BASE_URL}/photographers?limit=100`, {
                    headers: token ? { 'Authorization': `Bearer ${token}` } : {}
                });
                const data = await res.json();
                if (data.success) {
                    const uid = currentUser._id || currentUser.id;
                    const myProfile = data.photographers.find(p => p.user && (p.user._id === uid || p.user._id === uid));
                    if (myProfile) {
                        currentUser._photographerId = myProfile._id;
                        currentUser.bio = myProfile.bio || '';
                        currentUser.specialties = myProfile.specialties || [];
                        currentUser.hourlyRate = myProfile.pricing ? myProfile.pricing.hourlyRate : 150;
                        currentUser.experience = myProfile.experience ? (myProfile.experience.years || myProfile.experience.yearsOfExperience || 0) : 0;
                        currentUser.location = myProfile.location
                            ? [myProfile.location.city, myProfile.location.state].filter(Boolean).join(', ')
                            : '';
                        const rawImg = myProfile.profilePhoto || '';
                        if (rawImg && (rawImg.startsWith('http') || rawImg.startsWith('data:'))) {
                            currentUser.profileImage = rawImg;
                        }
                        currentUser.portfolio = myProfile.portfolio || [];
                        currentUser.backupCount = myProfile.backupCount || 0;
                        localStorage.setItem(STORAGE_KEYS.currentUser, JSON.stringify(currentUser));
                    }
                }
            } catch(e) { console.warn('Profile refresh failed:', e.message); }

            // Fetch bookings from API
            let apiBookings = [];
            try {
                const token = localStorage.getItem('authToken');
                const res = await fetch(`${API_BASE_URL}/bookings?limit=50`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (data.success) apiBookings = data.bookings || [];
            } catch(e) { console.warn('Could not load bookings from API:', e.message); }

            displayPhotographerDashboard(currentUser, apiBookings);
        }

        function displayPhotographerDashboard(photographer, apiBookings) {
            const bookingsFromAPI = apiBookings || [];
            console.log('Displaying dashboard for photographer:', photographer);
            
            const profileInfo = document.getElementById('dashboard-profile-info');
            if (profileInfo) {
                const hasPhoto = photographer.profileImage && !photographer.profileImage.includes('placehold.co') && !photographer.profileImage.includes('default');
                const avatar = hasPhoto ? photographer.profileImage
                    : `https://placehold.co/400x400/a78bfa/ffffff?text=${encodeURIComponent((photographer.name || 'P').charAt(0))}`;
                profileInfo.innerHTML = `
                    <div class="text-center">
                        <img src="${avatar}" alt="${photographer.name}" class="w-20 h-20 rounded-full mx-auto mb-3 object-cover">
                        <h4 class="font-semibold">${photographer.name}</h4>
                        <p class="text-sm text-slate-600">${photographer.specialties && photographer.specialties.length ? photographer.specialties.join(', ') : 'Photographer'}</p>
                        ${photographer.experience ? `<p class="text-sm text-slate-500 mt-1">${photographer.experience}+ yrs exp</p>` : ''}
                        ${photographer.hourlyRate ? `<p class="text-sm font-semibold text-orange-600">$${photographer.hourlyRate}/hr</p>` : ''}
                    </div>
                `;
            }

            // --- Profile Completion ---
            const completionFields = [
                { label: 'Profile Photo',    done: !!(photographer.profileImage && !photographer.profileImage.includes('placehold.co') && !photographer.profileImage.includes('default')) },
                { label: 'Bio',              done: !!(photographer.bio && photographer.bio.trim().length > 5) },
                { label: 'Specialties',      done: !!(photographer.specialties && photographer.specialties.length > 0) },
                { label: 'Hourly Rate',      done: !!(photographer.hourlyRate && photographer.hourlyRate > 0) },
                { label: 'Experience',       done: !!(photographer.experience && photographer.experience > 0) },
                { label: 'Location',         done: !!(photographer.location && photographer.location.trim().length > 0) },
                { label: 'Portfolio Photos', done: !!(photographer.portfolio && photographer.portfolio.length > 0) },
                { label: 'Backup Team Info', done: !!(photographer.backupCount && photographer.backupCount > 0) },
            ];
            const doneCount = completionFields.filter(f => f.done).length;
            const pct = Math.round((doneCount / completionFields.length) * 100);
            const card = document.getElementById('profile-completion-card');
            if (card) {
                card.classList.remove('hidden');
                const bar = document.getElementById('completion-bar');
                const pctEl = document.getElementById('completion-percent');
                const list = document.getElementById('completion-checklist');
                if (bar) {
                    bar.style.width = pct + '%';
                    bar.className = 'h-3 rounded-full transition-all duration-500 ' + (pct === 100 ? 'bg-green-500' : pct >= 60 ? 'bg-orange-500' : 'bg-red-400');
                }
                if (pctEl) {
                    pctEl.textContent = pct + '%';
                    pctEl.className = 'text-sm font-bold ' + (pct === 100 ? 'text-green-600' : pct >= 60 ? 'text-orange-600' : 'text-red-500');
                }
                if (list) list.innerHTML = completionFields.map(f =>
                    `<li class="flex items-center gap-1">${f.done ? '✅' : '⬜'} <span class="${f.done ? 'line-through text-slate-400' : 'text-slate-700'}">${f.label}</span></li>`
                ).join('');
            }
            
            // Use API bookings (already passed in) â‚¬ no localStorage
            const photographerBookings = bookingsFromAPI;
            
            console.log('Found bookings:', photographerBookings.length);
            
            // Update stats
            const totalBookings = photographerBookings.length;
            const thisMonth = new Date().getMonth();
            const thisYear = new Date().getFullYear();
            const monthlyBookings = photographerBookings.filter(booking => {
                const bookingDate = new Date(booking.date);
                return bookingDate.getMonth() === thisMonth && bookingDate.getFullYear() === thisYear;
            }).length;
            
            // Update stats elements with error checking
            const totalBookingsEl = document.getElementById('total-bookings');
            const monthlyBookingsEl = document.getElementById('monthly-bookings');
            const portfolioCountEl = document.getElementById('portfolio-count');
            const averageRatingEl = document.getElementById('average-rating');
            
            if (totalBookingsEl) totalBookingsEl.textContent = totalBookings;
            if (monthlyBookingsEl) monthlyBookingsEl.textContent = monthlyBookings;
            if (portfolioCountEl) portfolioCountEl.textContent = photographer.portfolio ? photographer.portfolio.length : '0';
            if (averageRatingEl) averageRatingEl.textContent = '5.0';
            
            // Display portfolio images in dashboard
            displayPortfolioInDashboard(photographer);
            
            // Display dashboard bookings with client details
            const container = document.getElementById('dashboard-bookings');
            if (container) {
                if (photographerBookings.length === 0) {
                    container.innerHTML = '<div class="text-center py-12 text-slate-400"><p class="text-4xl mb-4">📅</p><p class="text-base">No bookings yet. Clients will find you through your profile!</p></div>';
                } else {
                    const bookingsHTML = photographerBookings.map(booking => {
                        const formatTime = (time) => {
                            if (!time) return '';
                            const [hour, minute] = time.split(':');
                            const h = parseInt(hour);
                            if (h === 0) return `12:${minute} AM`;
                            if (h < 12) return `${h}:${minute} AM`;
                            if (h === 12) return `12:${minute} PM`;
                            return `${h - 12}:${minute} PM`;
                        };

                        const formatDate = (dateStr) => {
                            if (!dateStr) return '';
                            return new Date(dateStr).toLocaleDateString('en-US', {
                                month: 'short', day: 'numeric', year: 'numeric'
                            });
                        };

                        // Support both API field names and old localStorage field names
                        const client = booking.client || {};
                        const clientName = client.name || booking.clientName || 'Unknown Client';
                        const clientEmail = client.email || booking.clientEmail || '';
                        const clientPhone = client.phone || booking.clientPhone || '';
                        const clientImg = (client.profileImage && !client.profileImage.includes('default')) ? client.profileImage
                            : `https://placehold.co/100x100/f97316/ffffff?text=${encodeURIComponent(clientName.charAt(0))}`;
                        const status = booking.bookingStatus || booking.status || 'pending';
                        const bookingDate = booking.bookingDate || booking.date;
                        const startTime = booking.startTime || booking.time;
                        const endTime = booking.endTime || '';
                        const eventType = booking.eventType || booking.sessionType || '';
                        const location = booking.location?.address || booking.location || '';
                        const notes = booking.specialRequests || booking.requirements || '';
                        const total = booking.totalAmount || booking.totalCost || 0;
                        const bId = booking._id || booking.id;

                        const statusColors = {
                            pending: 'bg-yellow-100 text-yellow-800',
                            confirmed: 'bg-green-100 text-green-800',
                            in_progress: 'bg-blue-100 text-blue-800',
                            completed: 'bg-slate-100 text-slate-700',
                            cancelled: 'bg-red-100 text-red-800'
                        };

                        return `
                            <div class="bg-white border border-slate-200 rounded-xl p-5 shadow-sm hover:shadow-md transition-all">
                                <div class="flex items-start justify-between gap-3">
                                    <div class="flex items-start gap-3">
                                        <img src="${clientImg}" alt="${clientName}"
                                             class="w-12 h-12 rounded-full object-cover flex-shrink-0 border-2 border-slate-100">
                                        <div>
                                            <h4 class="font-semibold text-slate-800 text-base">${clientName}</h4>
                                            <p class="text-sm text-slate-500 flex items-center gap-1 mt-0.5">
                                                <svg class="w-3.5 h-3.5 text-slate-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                                                ${clientEmail}
                                            </p>
                                            ${clientPhone ? `<p class="text-sm text-slate-500 flex items-center gap-1 mt-0.5"><svg class="w-3.5 h-3.5 text-slate-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>${clientPhone}</p>` : ''}
                                        </div>
                                    </div>
                                    <span class="px-3 py-1 rounded-full text-xs font-semibold whitespace-nowrap ${statusColors[status] || statusColors.pending}">
                                        ${status.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}
                                    </span>
                                </div>

                                <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-3 bg-slate-50 rounded-lg p-3 text-sm">
                                    <div>
                                        <p class="text-slate-400 text-xs uppercase tracking-wide font-medium">Date</p>
                                        <p class="text-slate-800 font-medium mt-0.5">${formatDate(bookingDate)}</p>
                                    </div>
                                    <div>
                                        <p class="text-slate-400 text-xs uppercase tracking-wide font-medium">Time</p>
                                        <p class="text-slate-800 font-medium mt-0.5">${formatTime(startTime)}${endTime ? ' &ndash; ' + formatTime(endTime) : ''}</p>
                                    </div>
                                    <div>
                                        <p class="text-slate-400 text-xs uppercase tracking-wide font-medium">Type</p>
                                        <p class="text-slate-800 font-medium mt-0.5 capitalize">${eventType || '&mdash;'}</p>
                                    </div>
                                    ${location ? `<div><p class="text-slate-400 text-xs uppercase tracking-wide font-medium">Location</p><p class="text-slate-800 font-medium mt-0.5">${location}</p></div>` : ''}
                                </div>

                                ${notes ? `<div class="mt-3 p-3 bg-orange-50 border border-orange-100 rounded-lg"><p class="text-xs text-orange-700 uppercase tracking-wide font-semibold mb-1">Notes</p><p class="text-slate-700 text-sm">${notes}</p></div>` : ''}

                                <div class="mt-4 flex justify-between items-center">
                                    <p class="font-bold text-orange-600 text-base">Total: $${total}</p>
                                    <div class="flex gap-2">
                                        ${status === 'pending' ? `
                                            <button onclick="updateBookingStatusAPI('${bId}', 'confirmed')"
                                                    class="px-4 py-1.5 bg-green-600 text-white rounded-full text-sm font-medium hover:bg-green-700 transition-colors">Confirm</button>
                                            <button onclick="updateBookingStatusAPI('${bId}', 'cancelled')"
                                                    class="px-4 py-1.5 bg-red-500 text-white rounded-full text-sm font-medium hover:bg-red-600 transition-colors">Decline</button>
                                        ` : status === 'confirmed' ? `
                                            <button onclick="updateBookingStatusAPI('${bId}', 'completed')"
                                                    class="px-4 py-1.5 bg-blue-600 text-white rounded-full text-sm font-medium hover:bg-blue-700 transition-colors">Mark Complete</button>
                                        ` : ''}
                                    </div>
                                </div>

                                <p class="mt-2 text-xs text-slate-400">Booking ID: ${bId}</p>
                            </div>
                        `;
                    }).join('');

                    container.innerHTML = bookingsHTML;
                }
            }
        }
        
        // Function to display portfolio images in dashboard
        function displayPortfolioInDashboard(photographer) {
            // Find a place to display portfolio or create one
            let portfolioContainer = document.getElementById('dashboard-portfolio-display');
            
            if (!portfolioContainer) {
                // Create portfolio display section in the profile summary
                const profileCard = document.querySelector('#photographer-dashboard-page .bg-white');
                if (profileCard) {
                    const portfolioSection = document.createElement('div');
                    portfolioSection.id = 'dashboard-portfolio-display';
                    portfolioSection.className = 'mt-6';
                    portfolioSection.innerHTML = `
                        <h4 class="text-lg font-semibold text-slate-700 mb-3">Portfolio Preview</h4>
                        <div id="portfolio-images-container" class="grid grid-cols-2 gap-2"></div>
                    `;
                    profileCard.appendChild(portfolioSection);
                    portfolioContainer = portfolioSection;
                }
            }
            
            const imagesContainer = document.getElementById('portfolio-images-container');
            if (!imagesContainer) return;
            
            if (!photographer.portfolio || photographer.portfolio.length === 0) {
                imagesContainer.innerHTML = '<p class="col-span-2 text-center text-slate-500 text-sm">No portfolio images yet</p>';
                return;
            }
            
            // Display first 4 portfolio images
            const imagesToShow = photographer.portfolio.slice(0, 4);
            imagesContainer.innerHTML = imagesToShow.map((portfolioItem, index) => {
                const imageData = portfolioItem.imageUrl || portfolioItem.data || (typeof portfolioItem === 'string' ? portfolioItem : '');
                return `
                    <div class="relative group cursor-pointer" onclick="viewPortfolioImage('${photographer.id}', ${index})">
                        <img src="${imageData}" 
                             alt="Portfolio ${index + 1}" 
                             class="w-full h-20 object-cover rounded-lg border-2 border-slate-200 hover:border-orange-400 transition-colors">
                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-opacity rounded-lg flex items-center justify-center">
                            <div class="opacity-0 group-hover:opacity-100 text-white text-xs">View</div>
                        </div>
                    </div>
                `;
            }).join('') + (photographer.portfolio.length > 4 ? `
                <div class="col-span-2 text-center">
                    <button onclick="viewFullPortfolio('${photographer.id}')" 
                            class="text-sm text-orange-600 hover:text-orange-800 font-medium">
                        View All ${photographer.portfolio.length} Images â€ 
                    </button>
                </div>
            ` : '');
        }
        
        // Function to view portfolio image in modal
        window.viewPortfolioImage = function(photographerId, imageIndex) {
            const photographer = allPhotographers.find(p => p.id === photographerId) || currentUser;
            if (!photographer || !photographer.portfolio || !photographer.portfolio[imageIndex]) return;
            
            const imageData = photographer.portfolio[imageIndex].imageUrl || photographer.portfolio[imageIndex].data || (typeof photographer.portfolio[imageIndex] === 'string' ? photographer.portfolio[imageIndex] : '');
            const imageName = photographer.portfolio[imageIndex].title || photographer.portfolio[imageIndex].name || `Portfolio Image ${imageIndex + 1}`;
            
            // Create modal to view image
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="relative max-w-4xl max-h-full">
                    <img src="${imageData}" alt="${imageName}" class="max-w-full max-h-full object-contain rounded-lg">
                    <button onclick="this.closest('.fixed').remove()" 
                            class="absolute top-4 right-4 bg-white text-black rounded-full w-8 h-8 flex items-center justify-center hover:bg-gray-200">
                        ×
                    </button>
                    <div class="absolute bottom-4 left-4 bg-black bg-opacity-60 text-white p-2 rounded">
                        ${imageName}
                    </div>
                </div>
            `;
            
            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
            
            document.body.appendChild(modal);
        };
        
        // Function to view full portfolio
        window.viewFullPortfolio = function(photographerId) {
            const photographer = allPhotographers.find(p => p.id === photographerId) || currentUser;
            if (!photographer || !photographer.portfolio) return;
            
            showPage('photographer-portfolio-view');
            setTimeout(() => {
                displayFullPortfolio(photographer);
            }, 100);
        };
        
        function displayFullPortfolio(photographer) {
            let portfolioPage = document.getElementById('photographer-portfolio-view');
            if (!portfolioPage) {
                // Create portfolio view page if it doesn't exist
                portfolioPage = document.createElement('div');
                portfolioPage.id = 'photographer-portfolio-view';
                portfolioPage.className = 'page container mx-auto px-6 py-16';
                portfolioPage.innerHTML = `
                    <div class="text-center mb-8">
                        <h1 class="text-4xl font-bold font-serif-display">${photographer.name}'s Portfolio</h1>
                        <p class="text-lg text-slate-600 mt-2">Professional photography portfolio</p>
                        <button onclick="showPage('photographer-dashboard-page')" 
                                class="mt-4 bg-orange-500 text-white px-6 py-2 rounded-md hover:bg-orange-600">
                            â€  Back to Dashboard
                        </button>
                    </div>
                    <div id="full-portfolio-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Portfolio images will be inserted here -->
                    </div>
                `;
                document.body.appendChild(portfolioPage);
            }
            
            const container = document.getElementById('full-portfolio-container');
            if (!container) return;
            
            if (!photographer.portfolio || photographer.portfolio.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-slate-500">No portfolio images available</div>';
                return;
            }
            
            container.innerHTML = photographer.portfolio.map((portfolioItem, index) => {
                const imageData = portfolioItem.data || portfolioItem;
                const imageName = portfolioItem.name || `Portfolio Image ${index + 1}`;
                return `
                    <div class="bg-white rounded-lg shadow-md overflow-hidden">
                        <img src="${imageData}" 
                             alt="${imageName}" 
                             class="w-full h-64 object-cover cursor-pointer hover:opacity-90 transition-opacity"
                             onclick="viewPortfolioImage('${photographer.id}', ${index})">
                        <div class="p-4">
                            <p class="text-sm text-slate-600 truncate">${imageName}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Function to update booking status via API
        window.updateBookingStatusAPI = async function(bookingId, newStatus) {
            const token = localStorage.getItem('authToken');
            try {
                const res = await fetch(`${API_BASE_URL}/bookings/${bookingId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                const data = await res.json();
                if (data.success) {
                    const msgs = {
                        confirmed: 'â“ Booking confirmed! Client has been notified.',
                        rejected: ' Booking declined.',
                        cancelled: ' Booking cancelled.',
                        completed: 'â“ Marked as completed!'
                    };
                    alert(msgs[newStatus] || 'Booking updated.');
                    await loadPhotographerDashboard();
                } else {
                    alert('Update failed: ' + (data.message || 'Unknown error'));
                }
            } catch(e) {
                alert('Connection error. Please try again.');
                console.error(e);
            }
        };

        // Function to update booking status (legacy localStorage fallback)
        window.updateBookingStatus = function(bookingId, newStatus) {
            updateBookingStatusAPI(bookingId, newStatus);
        };

        // Load dashboard data based on user role
        function loadDashboard() {
            if (!currentUser) return;
            
            if (currentUser.role === 'photographer') {
                loadPhotographerDashboard();
            } else {
                loadClientDashboard();
            }
        }

        function loadClientDashboard() {
            // Show client profile info at top
            const profileInfo = document.getElementById('dashboard-profile-info');
            if (profileInfo && currentUser) {
                const avatar = (currentUser.profileImage && !currentUser.profileImage.includes('default'))
                    ? currentUser.profileImage
                    : `https://placehold.co/400x400/f97316/ffffff?text=${encodeURIComponent((currentUser.name || 'C').charAt(0))}`;
                profileInfo.innerHTML = `
                    <div class="text-center">
                        <img src="${avatar}" alt="${currentUser.name}"
                             class="w-20 h-20 rounded-full mx-auto mb-3 object-cover">
                        <h4 class="font-semibold text-slate-800">${currentUser.name || ''}</h4>
                        <p class="text-sm text-slate-500 mt-1">${currentUser.email || ''}</p>
                        ${currentUser.phone ? `<p class="text-sm text-slate-500">${currentUser.phone}</p>` : ''}
                        <span class="inline-block mt-2 px-3 py-1 bg-orange-100 text-orange-700 text-xs font-medium rounded-full">Client</span>
                    </div>
                `;
            }

            // Load bookings from API
            loadClientBookingsFromAPI();
        }

        async function loadClientBookingsFromAPI() {
            const container = document.getElementById('dashboard-bookings');
            const token = localStorage.getItem('authToken');
            let clientBookings = [];
            try {
                const res = await fetch(`${API_BASE_URL}/bookings?limit=50`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (data.success) clientBookings = data.bookings || [];
            } catch(e) { console.warn('Could not load client bookings:', e.message); }

            // Update stats
            document.getElementById('total-bookings').textContent = clientBookings.length;
            document.getElementById('average-rating').textContent = 'N/A';
            document.getElementById('portfolio-count').textContent = 'N/A';
            const thisMonth = new Date().getMonth(), thisYear = new Date().getFullYear();
            document.getElementById('monthly-bookings').textContent = clientBookings.filter(b => {
                const d = new Date(b.bookingDate || b.date);
                return d.getMonth() === thisMonth && d.getFullYear() === thisYear;
            }).length;

            if (!container) return;
            if (clientBookings.length === 0) {
                container.innerHTML = '<p class="text-slate-500 text-center py-8">No bookings yet. Browse photographers to book your first session!</p>';
                return;
            }

            const allBookings = clientBookings; // alias kept for old code compatibility
            // Fall through to the legacy render block below to avoid duplication
            const bookingsHTML = clientBookings.map(booking => {
                const formatTime = (time) => {
                    if (!time) return '';
                    const [hour, minute] = time.split(':');
                    const h = parseInt(hour);
                    if (h === 0) return `12:${minute} AM`;
                    if (h < 12) return `${h}:${minute} AM`;
                    if (h === 12) return `12:${minute} PM`;
                    return `${h - 12}:${minute} PM`;
                };
                const formatDate = (dateStr) => {
                    if (!dateStr) return '';
                    return new Date(dateStr).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                };
                const statusColors = { pending: 'bg-yellow-100 text-yellow-800', confirmed: 'bg-green-100 text-green-800', completed: 'bg-blue-100 text-blue-800', cancelled: 'bg-red-100 text-red-800' };
                const photog = booking.photographer || {};
                const photogName = photog.businessName || photog.name || booking.photographerName || 'Photographer';
                const photogEmail = photog.user ? (photog.user.email || '') : (photog.email || '');
                const photogPhone = photog.user ? (photog.user.phone || '') : (photog.phone || '');
                const photogImg = (photog.profilePhoto && photog.profilePhoto.startsWith('http')) ? photog.profilePhoto : `https://placehold.co/100x100/94a3b8/ffffff?text=P`;
                const status = booking.bookingStatus || booking.status || 'pending';
                return `
                    <div class="border border-slate-200 rounded-xl p-4 bg-white">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-3">
                                <img src="${photogImg}" alt="${photogName}" class="w-10 h-10 rounded-full object-cover">
                                <div>
                                    <h4 class="font-semibold text-slate-800">${photogName}</h4>
                                    <p class="text-xs text-slate-500">${booking.eventType || booking.sessionType || ''}</p>
                                </div>
                            </div>
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${statusColors[status] || 'bg-slate-100 text-slate-700'}">${status.charAt(0).toUpperCase() + status.slice(1)}</span>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-sm text-slate-600">
                            <div><span class="font-medium text-slate-700">Date:</span> ${formatDate(booking.bookingDate || booking.date)}</div>
                            <div><span class="font-medium text-slate-700">Time:</span> ${formatTime(booking.startTime || booking.time)}</div>
                            <div><span class="font-medium text-slate-700">Location:</span> ${booking.location?.address || booking.location || 'N/A'}</div>
                            <div><span class="font-medium text-slate-700">Total:</span> $${booking.totalAmount || booking.totalCost || 0}</div>
                        </div>
                        ${photogEmail || photogPhone ? `
                        <div class="mt-3 pt-3 border-t border-slate-100 flex flex-wrap gap-3">
                            ${photogEmail ? `<a href="mailto:${photogEmail}" class="flex items-center gap-1 text-sm text-orange-600 hover:text-orange-800 font-medium"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>Email Photographer</a>` : ''}
                            ${photogPhone ? `<a href="tel:${photogPhone}" class="flex items-center gap-1 text-sm text-green-600 hover:text-green-800 font-medium"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>Call Photographer</a>` : ''}
                        </div>` : ''}
                    </div>
                `;
            }).join('');
            container.innerHTML = bookingsHTML;

            // Original localStorage-based function code below (kept for fallback reference)
            const _allBookings_legacy = JSON.parse(localStorage.getItem('lenslink_bookings') || '[]');
            const _clientBookings_legacy = _allBookings_legacy.filter(b => false); // disabled
            // Stats already updated above
            void _clientBookings_legacy; // suppress warning
        }

        function getStatusColor(status) {
            switch (status) {
                case 'confirmed': return 'bg-green-100 text-green-800';
                case 'pending': return 'bg-yellow-100 text-yellow-800';
                case 'completed': return 'bg-blue-100 text-blue-800';
                case 'cancelled': return 'bg-red-100 text-red-800';
                default: return 'bg-slate-100 text-slate-800';
            }
        }

        // --- Profile Photo Utility Functions ---
        function convertFileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // Compress and resize image for faster loading
        function compressImage(file, maxWidth = 400, maxHeight = 400, quality = 0.8) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    // Calculate new dimensions
                    let { width, height } = img;
                    
                    if (width > height) {
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width = (width * maxHeight) / height;
                            height = maxHeight;
                        }
                    }
                    
                    // Set canvas dimensions
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Draw and compress image
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Convert to base64 with compression
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                    resolve(compressedDataUrl);
                };
                
                img.src = URL.createObjectURL(file);
            });
        }

        // Validate image file
        function validateImageFile(file) {
            const maxSize = 10 * 1024 * 1024; // 10MB limit
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
            
            if (!allowedTypes.includes(file.type)) {
                return { valid: false, error: 'Please select a valid image file (JPEG, PNG, GIF, or WebP)' };
            }
            
            if (file.size > maxSize) {
                return { valid: false, error: 'Image file size must be less than 10MB' };
            }
            
            return { valid: true };
        }

        // Preview image before upload
        function previewProfileImage(input) {
            const file = input.files[0];
            const previewContainer = document.getElementById('profile-image-preview');
            
            if (!file) {
                if (previewContainer) previewContainer.innerHTML = '';
                return;
            }
            
            // Validate file
            const validation = validateImageFile(file);
            if (!validation.valid) {
                alert(validation.error);
                input.value = '';
                if (previewContainer) previewContainer.innerHTML = '';
                return;
            }
            
            // Show loading indicator
            if (previewContainer) {
                previewContainer.innerHTML = `
                    <div class="text-center py-4">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-orange-500 mx-auto"></div>
                        <p class="text-sm text-slate-600 mt-2">Processing image...</p>
                    </div>
                `;
            }
            
            // Compress and preview image with error handling
            compressImage(file).then(compressedDataUrl => {
                if (previewContainer) {
                    const originalSize = (file.size / 1024).toFixed(1);
                    const compressedSize = (compressedDataUrl.length * 0.75 / 1024).toFixed(1); // Approximate size
                    
                    previewContainer.innerHTML = `
                        <div class="text-center">
                            <img src="${compressedDataUrl}" 
                                 alt="Profile preview" 
                                 class="w-32 h-32 rounded-full mx-auto object-cover border-4 border-orange-200 shadow-lg">
                            <p class="text-sm text-green-600 mt-2">
                                â“ Image optimized: ${originalSize}KB â€  ${compressedSize}KB
                            </p>
                            <p class="text-xs text-slate-500">
                                Image will load quickly for your clients!
                            </p>
                        </div>
                    `;
                }
                
                // Store compressed image for later use
                input.compressedImage = compressedDataUrl;
            }).catch(error => {
                console.error('Image processing failed:', error);
                if (previewContainer) {
                    previewContainer.innerHTML = `
                        <div class="text-center py-4">
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                                <p class="text-sm text-yellow-700">
                                    ï Image processing failed. Don't worry - you can still register!
                                </p>
                                <p class="text-xs text-yellow-600 mt-1">
                                    A default profile image will be used.
                                </p>
                            </div>
                        </div>
                    `;
                }
                // Clear the compressed image so registration uses default
                input.compressedImage = null;
            });
        }

        // Portfolio images preview and management
        let portfolioImages = [];
        
        function previewPortfolioImages(input) {
            const files = Array.from(input.files);
            const previewContainer = document.getElementById('portfolio-images-preview');
            const generateBtn = document.getElementById('generate-portfolio-pdf');
            
            if (!files.length) {
                if (previewContainer) previewContainer.innerHTML = '';
                if (generateBtn) generateBtn.disabled = true;
                portfolioImages = [];
                return;
            }
            
            // Limit to 10 images
            if (files.length > 10) {
                alert('Please select maximum 10 images for your portfolio');
                input.value = '';
                return;
            }
            
            // Validate all files
            for (let file of files) {
                const validation = validateImageFile(file);
                if (!validation.valid) {
                    alert(`Error with "${file.name}": ${validation.error}`);
                    input.value = '';
                    if (previewContainer) previewContainer.innerHTML = '';
                    return;
                }
            }
            
            // Show loading indicator
            if (previewContainer) {
                previewContainer.innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-orange-500 mx-auto"></div>
                        <p class="text-sm text-slate-600 mt-2">Processing ${files.length} portfolio images...</p>
                        <p class="text-xs text-slate-500">This may take a moment</p>
                    </div>
                `;
            }
            
            // Process all images
            portfolioImages = [];
            let processedCount = 0;
            
            files.forEach((file, index) => {
                compressImage(file).then(compressedDataUrl => {
                    portfolioImages.push({
                        name: file.name,
                        originalSize: file.size,
                        compressedData: compressedDataUrl,
                        index: index
                    });
                    
                    processedCount++;
                    
                    // Update preview once all images are processed
                    if (processedCount === files.length) {
                        updatePortfolioPreview();
                        if (generateBtn) generateBtn.disabled = false;
                    }
                }).catch(error => {
                    console.error(`Failed to process ${file.name}:`, error);
                    processedCount++;
                    
                    if (processedCount === files.length) {
                        updatePortfolioPreview();
                        if (generateBtn) generateBtn.disabled = portfolioImages.length === 0;
                    }
                });
            });
        }
        
        function updatePortfolioPreview() {
            const previewContainer = document.getElementById('portfolio-images-preview');
            if (!previewContainer) return;
            
            if (portfolioImages.length === 0) {
                previewContainer.innerHTML = '<p class="col-span-full text-center text-slate-500">No images processed</p>';
                return;
            }
            
            const totalOriginalSize = portfolioImages.reduce((sum, img) => sum + img.originalSize, 0);
            const totalCompressedSize = portfolioImages.reduce((sum, img) => sum + (img.compressedData.length * 0.75), 0);
            
            previewContainer.innerHTML = `
                <div class="col-span-full mb-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                    <p class="text-sm text-green-700 font-medium">
                        â“ ${portfolioImages.length} images processed successfully
                    </p>
                    <p class="text-xs text-green-600">
                        Total size optimized: ${(totalOriginalSize/1024/1024).toFixed(1)}MB â€  ${(totalCompressedSize/1024/1024).toFixed(1)}MB
                    </p>
                </div>
                ${portfolioImages.map((img, index) => `
                    <div class="relative group">
                        <img src="${img.compressedData}" 
                             alt="Portfolio ${index + 1}" 
                             class="w-full h-24 object-cover rounded-lg border-2 border-slate-200 hover:border-orange-300 transition-colors">
                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-opacity rounded-lg flex items-center justify-center">
                            <button onclick="removePortfolioImage(${index})" 
                                    class="opacity-0 group-hover:opacity-100 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600 transition-all">
                                ×
                            </button>
                        </div>
                        <p class="text-xs text-slate-500 mt-1 truncate">${img.name}</p>
                    </div>
                `).join('')}
            `;
        }
        
        function removePortfolioImage(index) {
            portfolioImages.splice(index, 1);
            updatePortfolioPreview();
            
            const generateBtn = document.getElementById('generate-portfolio-pdf');
            if (generateBtn) generateBtn.disabled = portfolioImages.length === 0;
        }
        
        function generatePortfolioPDF() {
            if (portfolioImages.length === 0) {
                alert('Please upload some portfolio images first');
                return;
            }
            
            // Create PDF using simple HTML/print approach
            const photographerName = document.getElementById('register-name')?.value || 'Photographer';
            
            // Create a new window with the portfolio
            const portfolioWindow = window.open('', '_blank', 'width=800,height=600');
            
            const portfolioHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${photographerName} - Portfolio</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; background: white; }
                        h1 { color: #1e293b; text-align: center; margin-bottom: 30px; }
                        .portfolio-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
                        .portfolio-item { text-align: center; page-break-inside: avoid; margin-bottom: 20px; }
                        img { max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
                        .print-btn { position: fixed; top: 20px; right: 20px; background: #f97316; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; z-index: 1000; }
                        .print-btn:hover { background: #ea580c; }
                        .footer { text-align: center; margin-top: 40px; color: #64748b; border-top: 1px solid #e2e8f0; padding-top: 20px; }
                        @media print { 
                            .print-btn { display: none; } 
                            body { margin: 0; }
                            .portfolio-grid { grid-template-columns: repeat(2, 1fr); }
                        }
                    </style>
                </head>
                <body>
                    <button class="print-btn" onclick="window.print()">ð€oe Print/Save as PDF</button>
                    <h1>${photographerName} - Photography Portfolio</h1>
                    <div class="portfolio-grid">
                        ${portfolioImages.map((img, index) => `
                            <div class="portfolio-item">
                                <img src="${img.compressedData}" alt="Portfolio Image ${index + 1}">
                                <p style="margin-top: 10px; font-size: 14px; color: #374151;">Portfolio Image ${index + 1}</p>
                            </div>
                        `).join('')}
                    </div>
                    <div class="footer">
                        <p><strong>Generated with LensLink Photography Platform</strong></p>
                        <p>Contact: ${document.getElementById('register-email')?.value || ''}</p>
                        <p>Phone: ${document.getElementById('register-phone')?.value || ''}</p>
                        <p>Location: ${document.getElementById('register-location')?.value || ''}</p>
                    </div>
                </body>
            `;
            
            portfolioWindow.document.write(portfolioHTML);
            portfolioWindow.document.close();
            
            // Auto-focus and show instructions after a short delay
            setTimeout(() => {
                portfolioWindow.focus();
                alert('â“ Portfolio opened in new window!\\n\\nð€oe Click "Print/Save as PDF" button to save or print your portfolio.\\n\\nð€™¡ Tip: Choose "Save as PDF" in the print dialog to create a downloadable portfolio file for clients.');
            }, 500);
        }

        // Make generatePortfolioPDF globally accessible
        window.generatePortfolioPDF = generatePortfolioPDF;

        // Portfolio viewer functions for clients
        function viewPhotographerPortfolioPDF(photographerId) {
            const photographer = allPhotographers.find(p => p.id === photographerId);
            if (!photographer || !photographer.portfolio || photographer.portfolio.length === 0) {
                alert('This photographer has not uploaded a portfolio yet.');
                return;
            }
            
            // Create portfolio PDF window for existing photographer
            const portfolioWindow = window.open('', '_blank', 'width=800,height=600');
            
            const portfolioHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${photographer.name} - Portfolio</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; background: white; }
                        h1 { color: #1e293b; text-align: center; margin-bottom: 30px; }
                        .photographer-info { text-align: center; margin-bottom: 40px; padding: 20px; background: #f8fafc; border-radius: 8px; }
                        .portfolio-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
                        .portfolio-item { text-align: center; page-break-inside: avoid; margin-bottom: 20px; }
                        img { max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
                        .print-btn { position: fixed; top: 20px; right: 20px; background: #f97316; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; z-index: 1000; }
                        .print-btn:hover { background: #ea580c; }
                        .footer { text-align: center; margin-top: 40px; color: #64748b; border-top: 1px solid #e2e8f0; padding-top: 20px; }
                        @media print { 
                            .print-btn { display: none; } 
                            body { margin: 0; }
                            .portfolio-grid { grid-template-columns: repeat(2, 1fr); }
                        }
                    </style>
                </head>
                <body>
                    <button class="print-btn" onclick="window.print()">ð€oe Print/Save as PDF</button>
                    <h1>${photographer.name} - Photography Portfolio</h1>
                    <div class="photographer-info">
                        <p><strong>Specialties:</strong> ${photographer.specialties ? photographer.specialties.join(', ') : 'Professional Photography'}</p>
                        <p><strong>Experience:</strong> ${photographer.experience || 5}+ years</p>
                        <p><strong>Rate:</strong> $${photographer.hourlyRate || 150}/hour</p>
                        <p><strong>Location:</strong> ${photographer.location || 'Available for travel'}</p>
                    </div>
                    <div class="portfolio-grid">
                        ${photographer.portfolio.map((item, index) => `
                            <div class="portfolio-item">
                                <img src="${item.imageUrl || item.data || (typeof item === 'string' ? item : '')}" alt="Portfolio Image ${index + 1}">
                                <p style="margin-top: 10px; font-size: 14px; color: #374151;">Portfolio Image ${index + 1}</p>
                            </div>
                        `).join('')}
                    </div>
                    <div class="footer">
                        <p><strong>Contact ${photographer.name}</strong></p>
                        <p>Email: ${photographer.email || ''}</p>
                        <p>Phone: ${photographer.phone || ''}</p>
                        <p><em>Generated with LensLink Photography Platform</em></p>
                    </div>
                </body>
                </html>
            `;
            
            portfolioWindow.document.write(portfolioHTML);
            portfolioWindow.document.close();
            
            setTimeout(() => {
                portfolioWindow.focus();
            }, 500);
        }
        
        function openPortfolioModal(photographerId, imageIndex) {
            const photographer = allPhotographers.find(p => p.id === photographerId);
            if (!photographer || !photographer.portfolio || !photographer.portfolio[imageIndex]) return;
            
            // Create a simple modal overlay
            const modalHTML = `
                <div id="portfolio-modal" class="fixed inset-0 z-50 bg-black bg-opacity-75 flex items-center justify-center p-4" onclick="closePortfolioModal()">
                    <div class="relative max-w-4xl max-h-full" onclick="event.stopPropagation()">
                        <button onclick="closePortfolioModal()" class="absolute -top-10 right-0 text-white text-xl hover:text-gray-300">â“ Close</button>
                        <img src="${photographer.portfolio[imageIndex].data || photographer.portfolio[imageIndex]}" 
                             alt="Portfolio image ${imageIndex + 1}" 
                             class="max-w-full max-h-full object-contain rounded-lg">
                        <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white p-4 rounded-b-lg">
                            <p class="text-center">Portfolio Image ${imageIndex + 1} of ${photographer.portfolio.length}</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('portfolio-modal');
            if (existingModal) existingModal.remove();
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        // Make globally accessible
        window.closePortfolioModal = function() {
            const modal = document.getElementById('portfolio-modal');
            if (modal) modal.remove();
        }

        // Send welcome email using EmailJS
        async function sendWelcomeEmail(userEmail, userName, userRole) {
            try {
                const templateParams = {
                    to_email: userEmail,
                    to_name: userName,
                    message: userRole === 'photographer' 
                        ? 'Thanks for creating your photographer account! Clients are waiting for you. Start showcasing your amazing work and get booked for events.'
                        : 'Thanks for logging in to LensLink! Find the best photographers for your special moments. Browse portfolios, read reviews, and book easily.'
                };

                await emailjs.send('service_7h7xr38', 'template_1ar2vae', templateParams);
                console.log('â“ Welcome email sent to:', userEmail);
            } catch (error) {
                console.log('ð€oe§ Email notification skipped:', error.message);
            }
        }

        // Expose for use in login handler
        window.sendWelcomeEmail = sendWelcomeEmail;
    </script>
</body>
</html>